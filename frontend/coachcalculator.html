<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Coach Server</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link
      href="https://fonts.googleapis.com/css?family=Noto Sans Mono"
      rel="stylesheet"
    />
    <style>
      .after_container {
        width: 100vw;
        height: 100vh;
        display: block;
      }

      .pre_container {
        width: 100vw;
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .black_background {
        background-color: black;
      }

      .pfill {
        margin: 0px;
        margin-top: -4px;
      }

      .lane {
        width: 5vw;
        max-width: 50px;
        height: 5vw;
        max-height: 50px;
        border-style: solid;
        border-width: 2px;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 200%;
        font-weight: 800;
        font-family: sans-serif;
        padding-top: 0.5%;
        padding-right: 0.25%;
      }

      .connectedLane {
        border-color: rgb(104, 230, 146);
        background-color: green;
      }

      .disconnected {
        border-color: blueviolet;
        background-color: brown;
        color: beige;
      }

      #upper_div {
        width: 100%;
        height: 20%;
        display: flex;
      }

      #lower_div {
        height: 80%;
        width: 100%;
        border-color: white;
        border-top-style: solid;
        border-top-width: 2px;
        display: flex;
        flex-direction: row;
        flex-wrap: nowrap;
        justify-content: flex-start;
        align-items: center;
        gap: 0.25vw;
      }

      #lanes_display {
        display: flex;
        flex-direction: row;
        flex-wrap: nowrap;
        justify-content: flex-start;
        align-items: center;
        gap: 0.25vw;
        overflow: auto;
        height: 100%;
      }

      #video_display {
        display: flex;
        flex-direction: row;
        flex-wrap: nowrap;
        justify-content: flex-start;
        align-items: center;
        gap: 0.25vw;
        overflow: auto;
        height: 100%;
      }

      #room_code {
        width: 25%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-size: 4vh;
        color: white;
        font-weight: 600;
        text-align: center;
      }

      #room_code_text_above {
        text-decoration: underline;
        height: fit-content;
        white-space: nowrap;
      }

      #room_code_text {
        height: fit-content;
      }

      .wrapper {
        height: 50%;
        width: 100%;
        display: flex;
        align-content: center;
        justify-content: center;
        flex-wrap: wrap;
      }

      #connections_div {
        float: left;
        width: 25%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.25vw;
        color: white;
        flex-wrap: wrap;
        padding: 3px;
      }

      #clock_container {
        height: 100%;
        width: 50%;
        display: flex;
        flex-direction: row;
        flex-wrap: nowrap;
        align-content: center;
        align-items: center;
        min-width: 235px;
        justify-content: center;
      }

      #clock_text {
        font-weight: 600;
        font-family: monospace;
        font-size: 10vmin;
        line-height: 100%;
        color: lime;
        height: fit-content;
      }

      .active_lane {
        border-color: lime;
        color: lime;
      }

      .disconnected_lane {
        border-color: red;
        color: red;
      }

      .lane_display_container {
        height: 98%;
        width: 320px;
        min-width: 320px;
        max-width: 350px;
        border-style: solid;
        border-width: 3px;
        border-radius: 10px;
        overflow: auto;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: space-evenly;
      }

      .control_lane {
        border-color: white;
        border: hidden;
        width: 160px;
        min-width: 160px;
        max-width: 160px;
        border-radius: 0px;
        border-color: white;
        border-right-width: 2px;
        border-right-style: solid;
        height: 100%;
      }

      .nearly_full_width {
        width: 96%;
      }

      .lane_label {
        text-align: center;
        text-decoration: underline;
      }

      .lane_clock {
        text-align: center;
        font-weight: 400;
        font-family: monospace;
      }

      .lane_table {
        width: 93%;
        border-color: white;
        color: white;
      }

      .LO_column {
        width: 25%;
        text-align: center;
        border-bottom-width: 2px;
      }

      .LO_column_data {
        font-weight: 800;
        font-family: monospace;
        text-align: right;
        font-size: 22px;
        border-bottom-width: 2px;
      }

      .middle_column {
        width: 12%;
        border-bottom-width: 2px;
        text-align: center;
        font-weight: bold;
      }

      .DA_coluumn {
        width: 63%;
        text-align: left;
        border-bottom-width: 2px;
      }

      .DA_column_data {
        text-align: left;
        font-size: 17px;
        font-weight: bold;
        border-bottom-width: 2px;
      }

      .lane_controls {
        width: 93%;
        margin: 10px;
        display: flex;
        justify-content: space-around;
      }

      .next_up_display {
        width: 93%;
        font-size: 30px;
      }

      .lane_split_panel {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        margin: 4px;
        border-radius: 9%;
        border-width: 2px;
        border-style: solid;
        padding: 15px;
        max-height: 45%;
      }

      .stopwatch_split_panel {
        display: flex;
        flex-direction: column;
        justify-content: space-evenly;
        align-items: center;
        margin: 4px;
        border-radius: 9%;
        border-width: 2px;
        border-style: solid;
        padding: 8px;
        max-height: 45%;
      }

      .stopwatch_button {
        width: 6vw;
        margin: 5px;
      }

      .stopwatch {
        font-size: 2.2vw;
      }

      .stopwatch_split {
        font-size: 1.5vw;
      }

      .controls_panel {
        display: flex;
        flex-direction: column;
        /*justify-content: space-evenly;*/
        justify-content: flex-start;
        align-items: center;
        width: 100%;
        height: 100%;
        padding-left: 4px;
        padding-right: 4px;
      }

      .split_button {
        width: 15vw;
        height: 15vh;
      }

      #splits_display {
        display: flex;
        flex-wrap: wrap;
        justify-content: flex-start;
        width: 100%;
        height: 100%;
      }

      #stopwatch_display {
        display: flex;
        flex-wrap: wrap;
        justify-content: flex-start;
        width: 100%;
        height: 100%;
      }

      .split {
        margin-top: 10px;
        font-size: 30px;
        font-weight: 600;
        font-family: monospace;
      }

      #clock_containing_div {
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      #controls_top_part {
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        padding-left: 4px;
        padding-right: 4px;
      }

      #controls_lower_part {
        width: 100%;
        display: flex;
        flex-direction: column;
        justify-content: space-evenly;
        align-items: center;
        flex-grow: 4;
      }

      .big_split_button_div {
        width: 100%;
        padding-right: 10px;
      }

      .big_split_button {
        width: 100%;
      }

      #options_div {
        position: absolute;
        width: 25vw;
        min-width: 275px;
        background-color: darkblue;
        z-index: 2;
        border-radius: 50px;
        padding: 20px;
        display: flex;
        flex-wrap: wrap;
        justify-content: space-evenly;
        align-items: center;
        top: 10vh;
        box-shadow: 0px 0px 13px 13px darkblue;
      }

      .control_button {
        margin-top: 4vh;
      }

      .aggressive_shadow {
        box-shadow: 0px 13px 13px black;
      }

      #app_settings_display {
        height: 100%;
        width: 100%;
        background-color: rebeccapurple;
      }

      .app_setting_label {
        color: white;
        text-align: right;
      }

      #app_settings_table {
        width: 48%;
      }

      td {
        padding-top: 10px;
        padding-right: 8px;
      }

      #video_display {
        color: white;
      }

      .category_div {
        width: 100%;
        background-color: green;
      }

      .video_spanner {
        width: 100%;
        background-color: red;
        display: flex;
        justify-content: flex-start;
        flex-wrap: nowrap;
        flex-direction: row;
      }

      .video_spacer {
        width: 20%;
        background-color: blue;
      }

      .video_link {
        width: 80%;
        background-color: purple;
      }

      #video_player_panel {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
      }

      #video_player_control_panel {
        width: 100%;
        height: 10%;
        display: flex;
        flex-direction: row;
        flex-wrap: nowrap;
        justify-content: space-evenly;
        align-items: center;
      }

      #video_player {
        width: 100%;
        height: 90%;
      }

      #player_blocker {
        position: absolute;
        top: 0;
        width: 100%;
        height: 100%;
      }

      #wrapper {
        width: 100%;
        height: 90%;
        position: relative;
      }

      #pick_set_display {
        height: 100%;
        width: 100%;
        position: absolute;
        top: 0;
        left: 0;
        background-color: lightgray;
      }
      #practices_display {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        height: 100%;
        width: 100%;
      }
      #practices_div {
        width: 30%;
        height: 90%;
        margin-left: 4vw;
        margin-top: 3vw;
        background-color: white;
        border-style: solid;
        border-color: darkgray;
        padding: 8px;
        border-radius: 8px;
        box-shadow: rgba(0, 0, 0, 0.16) 0px 1px 4px;
        overflow: auto;
        user-select: none;
      }
      #individual_practice {
        width: 50%;
        height: 90%;
        margin-top: 3vw;
        margin-right: 4vw;
        background-color: white;
        border-style: solid;
        border-color: darkgray;
        padding: 8px;
        border-radius: 8px;
        box-shadow: rgba(0, 0, 0, 0.16) 0px 1px 4px;
        overflow: auto;
      }
      .individual_practice_top_part {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
      }
      .individual_practice_bottom_part {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
        padding-top: 12px;
      }
      .label_wrapper {
        display: flex;
      }
      .practice_small_display {
        padding-left: 4px;
        padding-right: 4px;
        width: 100%;
        padding-top: 6px;
        padding-bottom: 6px;
        border-radius: 3px;
        white-space: nowrap;
        -webkit-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }
      .practice_small_display:last-child {
        padding-bottom: 3px;
      }
      .practice_small_display:first-child {
        padding-top: 3px;
      }

      .curly_brace_wrapper {
        display: flex;
        flex-direction: column;
        align-self: stretch;
      }
      .brace {
        width: 20px;
        height: 25%;
      }
      .curly_brace_part_one {
        border-left: 2px solid black;
        border-top-left-radius: 12px;
        margin-left: 18px;
      }
      .curly_brace_part_two {
        border-right: 2px solid black;
        border-bottom-right-radius: 12px;
      }
      .curly_brace_part_three {
        border-right: 2px solid black;
        border-top-right-radius: 12px;
      }
      .curly_brace_part_four {
        border-left: 2px solid black;
        border-bottom-left-radius: 12px;
        margin-left: 18px;
      }
      .individual_set {
        display: flex;
        align-items: center;
        flex: 1 1 auto;
        -webkit-user-select: none; /* Safari */
        -ms-user-select: none; /* IE 10 and IE 11 */
        user-select: none; /* Standard syntax */
      }
      .individual_practice_bottom_part > .individual_set {
        width: 98%;
        border-style: solid;
        border-width: 2px;
        box-shadow: rgba(0, 0, 0, 0.24) 0px 3px 8px;
        border-radius: 12px;
        padding-left: 6px;
        padding-right: 6px;
        padding-top: 3px;
        padding-bottom: 3px;
      }
      .set_display_side {
        height: 100%;
        flex: 1 1 auto;
      }
      .rep_part {
        padding-left: 5%;
      }
      #assign_lanes_popup {
        position: absolute;
        top: 0;
        left: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        height: 100%;
        backdrop-filter: blur(12px);
      }
      #assign_lanes_inner {
        display: flex;
        background-color: lightgray;
        flex-direction: column;
        padding: 20px;
        border-radius: 15px;
        border-style: solid;
      }
      .sendoff_match_wrapper {
        width: 100%;
        display: flex;
        justify-content: center;
        padding-top: 8px;
        padding-bottom: 8px;
      }
      .sendoff_match_wrapper > div {
        margin-right: 4px;
      }
      #assign_lanes_button {
        margin-top: 20px;
      }
    </style>
    <script src="https://www.youtube.co/iframe_api"></script>
  </head>
  <body onbeforeunload="return closeWebSocket()">
    <div id="container" class="pre_container">
      <button
        type="button"
        onclick="startApp()"
        id="fullscreenbutton"
        class="btn btn-primary"
      >
        Cick Me To Start App
      </button>
    </div>
    <div id="rotate" style="display: none">Rotate Screen</div>

    <script>
      const SKIP_FULLSCREEN = 1;
      const MILLS_TO_DISPLAY_SPLITS_DEFAULT = 10 * 1000;
      const MILLS_TO_DISPLAY_STOPWATCH_DEFAULT = 20 * 1000;
      const MULTI_DESCRIPTION_TYPE = Object.freeze({
        BY_ROUND: 1,
        SPLIT_EVENLY: 2,
        REPEAT_ONE_AT_A_TIME: 3,
      });
      if (!localStorage.getItem("mills_to_update_clock"))
        localStorage.setItem("mills_to_update_clock", 10);
      const MILLS_TO_UPDATE_CLOCK = parseInt(
        localStorage.getItem("mills_to_update_clock")
      );

      if (!localStorage.getItem("mills_to_sync_with_server"))
        localStorage.setItem("mills_to_sync_with_server", 2 * 60 * 1000);
      const MILLS_TO_SYNC_WITH_SERVER = parseInt(
        localStorage.getItem("mills_to_sync_with_server")
      );

      if (!localStorage.getItem("mills_to_display_splits"))
        localStorage.setItem(
          "mills_to_display_splits",
          MILLS_TO_DISPLAY_SPLITS_DEFAULT
        );
      let MILLS_TO_DISPLAY_SPLITS = parseInt(
        localStorage.getItem("mills_to_display_splits")
      );

      if (!localStorage.getItem("mills_to_display_stopwatch"))
        localStorage.setItem(
          "mills_to_display_stopwatch",
          MILLS_TO_DISPLAY_STOPWATCH_DEFAULT
        );
      let MILLS_TO_DISPLAY_STOPWATCH = parseInt(
        localStorage.getItem("mills_to_display_stopwatch")
      );

      if (!localStorage.getItem("coach_id"))
        localStorage.setItem("coach_id", createCoachID());

      const COACH_ID = localStorage.getItem("coach_id");

      function createCoachID() {
        let letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
        letters += letters.toLowerCase();
        letters += "1234567890";
        letters += "-_";

        let id = "";

        while (id.length < 20) {
          id += letters.charAt(Math.floor(Math.random() * letters.length));
        }

        return id;
      }

      let socket = undefined;
      const LANES = {};
      let clock;
      let time_delta;
      let additional_time_delta = 0;
      let roomKey;
      let lanes_display;
      let last_orientation = screen.orientation.type;
      let current_mode = 1;
      let last_touch = 0;
      let player;
    </script>
    <script>
      function closeWebSocket() {
        socket.close();
      }

      async function startApp() {
        var main_screen = document.getElementById("container");
        main_screen.classList.remove("pre_container");
        main_screen.classList.add("after_container");
        main_screen.classList.add("black_background");
        requestFullScreen(main_screen);
        requestScreenLock();

        const clearScreenOfBeginningControls = () => {
          const full_screen_button =
            document.getElementById("fullscreenbutton");
          full_screen_button.remove();
        };
        const buildUpperDisplay = () => {
          const upper_div = document.createElement("div");
          upper_div.id = "upper_div";
          main_screen.appendChild(upper_div);

          const addRoomCodeDiv = () => {
            const room_code_div = document.createElement("div");
            room_code_div.id = "room_code";
            upper_div.appendChild(room_code_div);

            const wrapper_one = document.createElement("div");
            const wrapper_two = document.createElement("div");
            wrapper_one.classList.add("wrapper");
            wrapper_two.classList.add("wrapper");

            room_code_div.appendChild(wrapper_one);
            room_code_div.appendChild(wrapper_two);

            const room_code_p = document.createElement("div");
            room_code_p.id = "room_code_text_above";
            room_code_p.innerHTML = "Room Code";
            wrapper_one.appendChild(room_code_p);

            const room_code_lower = document.createElement("div");
            room_code_lower.id = "room_code_text";
            room_code_lower.innerText = "---";
            wrapper_two.appendChild(room_code_lower);

            fitText(room_code_p);
            fitText(room_code_lower);
          };
          const addClockDiv = () => {
            const clock_container = document.createElement("div");
            clock_container.id = "clock_container";
            upper_div.appendChild(clock_container);

            const buildLeftOfClockButtonGroup = () => {
              const clock_minute_button_group = document.createElement("div");
              clock_minute_button_group.id = "clock_minute_button_group";
              clock_minute_button_group.classList.add("btn-group-vertical");
              clock_minute_button_group.role = "group";
              clock_minute_button_group.ariaLabel = "Vertical button group";
              clock_container.appendChild(clock_minute_button_group);

              const add_minute_button = document.createElement("button");
              add_minute_button.type = "button";
              add_minute_button.classList.add("btn");
              add_minute_button.classList.add("btn-primary");
              add_minute_button.innerText = "^";
              add_minute_button.addEventListener("click", addOneMinute);
              add_minute_button.disabled = true;
              clock_minute_button_group.appendChild(add_minute_button);

              const subtract_minute_button = document.createElement("button");
              subtract_minute_button.type = "button";
              subtract_minute_button.classList.add("btn");
              subtract_minute_button.classList.add("btn-primary");
              subtract_minute_button.innerText = "⌄";
              subtract_minute_button.disabled = true;
              subtract_minute_button.addEventListener(
                "click",
                subtractOneMinute
              );
              clock_minute_button_group.appendChild(subtract_minute_button);
            };
            const buildClock = () => {
              const clock_conatining_div = document.createElement("div");
              clock_conatining_div.id = "clock_containing_div";
              clock_container.appendChild(clock_conatining_div);

              const clock_p = document.createElement("dv");
              clock_p.id = "clock_text";
              clock_p.innerHTML = "00:00";
              clock_conatining_div.appendChild(clock_p);

              clock = clock_p;
            };
            const buildRightOfClockButtonGroup = () => {
              const after_clock_button_group = document.createElement("div");
              after_clock_button_group.id = "after_clock_button_group";
              after_clock_button_group.classList.add("btn-group-vertical");
              after_clock_button_group.role = "group";
              after_clock_button_group.ariaLabel = "Vertical button group";
              clock_container.appendChild(after_clock_button_group);

              const zero_out_button = document.createElement("button");
              zero_out_button.id = "zero_out_button";
              zero_out_button.type = "button";
              zero_out_button.classList.add("btn");
              zero_out_button.classList.add("btn-primary");
              zero_out_button.innerText = ":00";
              zero_out_button.addEventListener("click", setToZero);
              zero_out_button.disabled = true;
              after_clock_button_group.appendChild(zero_out_button);

              const sync_button = document.createElement("button");
              sync_button.id = "sync_button";
              sync_button.type = "button";
              sync_button.classList.add("btn");
              sync_button.classList.add("btn-primary");
              sync_button.innerText = "Sync";
              sync_button.addEventListener("click", syncClocks);
              sync_button.disabled = true;
              after_clock_button_group.appendChild(sync_button);
            };

            buildLeftOfClockButtonGroup();
            buildClock();
            buildRightOfClockButtonGroup();
          };
          const addConnectionsDiv = () => {
            const connections_div = document.createElement("div");
            connections_div.id = "connections_div";
            connections_div.innerText = "Connecting to server...";
            upper_div.appendChild(connections_div);
          };

          addRoomCodeDiv();
          addClockDiv();
          addConnectionsDiv();
        };
        const buildLowerDisplay = () => {
          const lower_div = document.createElement("div");
          lower_div.id = "lower_div";
          main_screen.appendChild(lower_div);

          const add_controls_div = () => {
            const controls_div = document.createElement("div");
            controls_div.id = "controls";
            controls_div.classList.add("lane_display_container");
            controls_div.classList.add("control_lane");
            lower_div.appendChild(controls_div);

            const controls_top_part = document.createElement("div");
            controls_top_part.id = "controls_top_part";
            controls_div.appendChild(controls_top_part);

            const controls_lower_part = document.createElement("div");
            controls_lower_part.id = "controls_lower_part";
            controls_div.appendChild(controls_lower_part);

            function add_options_selector() {
              let options_button = document.createElement("button");
              options_button.id = "options_button";
              options_button.classList.add("btn");
              options_button.classList.add("btn-primary");
              options_button.classList.add("nearly_full_width");
              options_button.style.marginTop = "1vh";
              options_button.innerText = "Options";
              options_button.addEventListener("click", optionsButtonClicked);
              options_button.disabled = true;
              controls_top_part.appendChild(options_button);

              const options_div = document.createElement("div");
              options_div.id = "options_div";
              options_div.addEventListener("click", ignoreClick);

              controls_top_part.appendChild(options_div);
              options_div.style.display = "none";
              options_div.style.left =
                options_div.parentElement.offsetWidth + "px";

              const send_off_mode_button = document.createElement("button");
              send_off_mode_button.id = "send_off_mode_button";
              send_off_mode_button.type = "button";
              send_off_mode_button.classList.add("btn");
              send_off_mode_button.classList.add("btn-primary");
              send_off_mode_button.classList.add("nearly_full_width");
              send_off_mode_button.classList.add("aggressive_shadow");
              send_off_mode_button.innerText = "Switch to Sendoff Mode";
              send_off_mode_button.addEventListener(
                "click",
                switchToSendoffMode
              );
              options_div.appendChild(send_off_mode_button);

              const split_mode_button = document.createElement("button");
              split_mode_button.id = "split_mode_button";
              split_mode_button.type = "button";
              split_mode_button.classList.add("btn");
              split_mode_button.classList.add("btn-primary");
              split_mode_button.classList.add("nearly_full_width");
              split_mode_button.classList.add("control_button");
              split_mode_button.classList.add("aggressive_shadow");
              split_mode_button.innerText = "Switch to Split Mode";
              split_mode_button.disabled = true;
              split_mode_button.addEventListener("click", switchToSplitMode);
              options_div.appendChild(split_mode_button);

              const stopwatch_mode_button = document.createElement("button");
              stopwatch_mode_button.id = "stopwatch_mode_button";
              stopwatch_mode_button.type = "button";
              stopwatch_mode_button.classList.add("btn");
              stopwatch_mode_button.classList.add("btn-primary");
              stopwatch_mode_button.classList.add("nearly_full_width");
              stopwatch_mode_button.classList.add("control_button");
              stopwatch_mode_button.classList.add("aggressive_shadow");
              stopwatch_mode_button.innerText = "Switch to Stopwatch Mode";
              stopwatch_mode_button.disabled = true;
              stopwatch_mode_button.addEventListener(
                "click",
                switchToStopwatchMode
              );
              options_div.appendChild(stopwatch_mode_button);

              const video_mode_button = document.createElement("button");
              video_mode_button.id = "video_mode_button";
              video_mode_button.type = "button";
              video_mode_button.classList.add("btn");
              video_mode_button.classList.add("btn-primary");
              video_mode_button.classList.add("nearly_full_width");
              video_mode_button.classList.add("control_button");
              video_mode_button.classList.add("aggressive_shadow");
              video_mode_button.innerText = "Switch to Video Mode";
              video_mode_button.disabled = true;
              video_mode_button.addEventListener("click", switchToVideoMode);
              options_div.appendChild(video_mode_button);

              const app_settings_button = document.createElement("button");
              app_settings_button.id = "app_settings_button";
              app_settings_button.type = "button";
              app_settings_button.classList.add("btn");
              app_settings_button.classList.add("btn-primary");
              app_settings_button.classList.add("nearly_full_width");
              app_settings_button.classList.add("control_button");
              app_settings_button.classList.add("aggressive_shadow");
              app_settings_button.innerText = "App Settings";
              app_settings_button.disabled = true;
              app_settings_button.addEventListener(
                "click",
                switchToAppSettings
              );
              options_div.appendChild(app_settings_button);
            }
            add_options_selector();

            const sendoff_controls_panel = document.createElement("div");
            sendoff_controls_panel.id = "sendoff_controls_panel";
            const split_controls_panel = document.createElement("div");
            split_controls_panel.id = "split_controls_panel";
            const stopwatch_controls_panel = document.createElement("div");
            stopwatch_controls_panel.id = "stopwatch_controls_panel";
            sendoff_controls_panel.classList.add("controls_panel");
            split_controls_panel.classList.add("controls_panel");
            stopwatch_controls_panel.classList.add("controls_panel");
            split_controls_panel.style.display = "none";
            stopwatch_controls_panel.style.display = "none";
            const video_controls_panel = document.createElement("div");
            video_controls_panel.id = "video_controls_panel";
            video_controls_panel.classList.add("controls_panel");
            const app_settings_controls_panel = document.createElement("div");
            app_settings_controls_panel.id = "app_settings_controls_panel";
            app_settings_controls_panel.classList.add("controls_panel");

            controls_lower_part.appendChild(sendoff_controls_panel);
            controls_lower_part.appendChild(split_controls_panel);
            controls_lower_part.appendChild(stopwatch_controls_panel);
            controls_lower_part.appendChild(video_controls_panel);
            controls_lower_part.appendChild(app_settings_controls_panel);

            const pick_set_button = document.createElement("button");
            pick_set_button.id = "pick_set_button";
            pick_set_button.type = "button";
            pick_set_button.classList.add("btn");
            pick_set_button.classList.add("btn-primary");
            pick_set_button.classList.add("nearly_full_width");
            pick_set_button.classList.add("control_button");
            pick_set_button.innerText = "Pick Set";
            pick_set_button.addEventListener("click", pickSetClicked);
            pick_set_button.disabled = true;
            sendoff_controls_panel.appendChild(pick_set_button);

            const start_on_top_button = document.createElement("button");
            start_on_top_button.id = "start_on_top_button";
            start_on_top_button.type = "button";
            start_on_top_button.classList.add("btn");
            start_on_top_button.classList.add("btn-success");
            start_on_top_button.classList.add("nearly_full_width");
            start_on_top_button.classList.add("control_button");
            start_on_top_button.innerText = "Start Set on next :00";
            start_on_top_button.disabled = true;
            sendoff_controls_panel.appendChild(start_on_top_button);

            const switch_mode_button = document.createElement("button");
            switch_mode_button.id = "switch_mode_button";
            switch_mode_button.type = "button";
            switch_mode_button.classList.add("btn");
            switch_mode_button.classList.add("btn-success");
            switch_mode_button.classList.add("nearly_full_width");
            switch_mode_button.classList.add("control_button");
            switch_mode_button.innerText = "Enable Lane Time Edit Mode";
            switch_mode_button.disabled = true;
            sendoff_controls_panel.appendChild(switch_mode_button);

            const pause_all_lanes_button = document.createElement("button");
            pause_all_lanes_button.id = "pause_all_lanes_button";
            pause_all_lanes_button.type = "button";
            pause_all_lanes_button.classList.add("btn");
            pause_all_lanes_button.classList.add("btn-warning");
            pause_all_lanes_button.classList.add("nearly_full_width");
            pause_all_lanes_button.classList.add("control_button");
            pause_all_lanes_button.innerText = "Pause All Lanes";
            pause_all_lanes_button.disabled = true;
            sendoff_controls_panel.appendChild(pause_all_lanes_button);

            const stop_all_lanes_button = document.createElement("button");
            stop_all_lanes_button.id = "stop_all_lanes_button";
            stop_all_lanes_button.type = "button";
            stop_all_lanes_button.classList.add("btn");
            stop_all_lanes_button.classList.add("btn-danger");
            stop_all_lanes_button.classList.add("nearly_full_width");
            stop_all_lanes_button.classList.add("control_button");
            stop_all_lanes_button.innerText = "Stop All Lanes";
            stop_all_lanes_button.disabled = true;
            sendoff_controls_panel.appendChild(stop_all_lanes_button);

            const stopwatch_start_all_lanes_button =
              document.createElement("button");
            stopwatch_start_all_lanes_button.type = "button";
            stopwatch_start_all_lanes_button.classList.add("btn");
            stopwatch_start_all_lanes_button.classList.add("btn-success");
            stopwatch_start_all_lanes_button.classList.add("nearly_full_width");
            stopwatch_start_all_lanes_button.classList.add("control_button");
            stopwatch_start_all_lanes_button.innerText = "Start All";
            stopwatch_start_all_lanes_button.addEventListener(
              "click",
              startAllStopwatchesClicked
            );
            stopwatch_controls_panel.appendChild(
              stopwatch_start_all_lanes_button
            );

            const stopwatch_stop_all_lanes_button =
              document.createElement("button");
            stopwatch_stop_all_lanes_button.type = "button";
            stopwatch_stop_all_lanes_button.classList.add("btn");
            stopwatch_stop_all_lanes_button.classList.add("btn-danger");
            stopwatch_stop_all_lanes_button.classList.add("nearly_full_width");
            stopwatch_stop_all_lanes_button.classList.add("control_button");
            stopwatch_stop_all_lanes_button.innerText = "Stop All";
            stopwatch_stop_all_lanes_button.addEventListener(
              "click",
              stopAllStopwatchesClicked
            );
            stopwatch_controls_panel.appendChild(
              stopwatch_stop_all_lanes_button
            );

            const stopwatch_clear_all_lanes_button =
              document.createElement("button");
            stopwatch_clear_all_lanes_button.type = "button";
            stopwatch_clear_all_lanes_button.classList.add("btn");
            stopwatch_clear_all_lanes_button.classList.add("btn-primary");
            stopwatch_clear_all_lanes_button.classList.add("nearly_full_width");
            stopwatch_clear_all_lanes_button.classList.add("control_button");
            stopwatch_clear_all_lanes_button.innerText = "Clear All";
            stopwatch_clear_all_lanes_button.addEventListener(
              "click",
              clearAllStopwatchesClicked
            );
            stopwatch_controls_panel.appendChild(
              stopwatch_clear_all_lanes_button
            );
          };
          const add_initial_empty_lanes_display = () => {
            lanes_display = document.createElement("div");
            lanes_display.id = "lanes_display";
            lower_div.appendChild(lanes_display);

            const send_info_button = document.createElement("button");
            send_info_button.id = "send_info_button";
            send_info_button.innerText = "Send Info...";
            send_info_button.addEventListener("click", sendInfo);

            const split_button = document.createElement("button");
            split_button.id = "split_button";
            split_button.innerText = "Split";
            split_button.addEventListener("click", Split);

            lanes_display.appendChild(send_info_button);
            lanes_display.appendChild(split_button);
          };
          const add_initial_empty_splits_display = () => {
            const lower_div = document.getElementById("lower_div");

            const splits_display = document.createElement("div");
            splits_display.id = "splits_display";
            splits_display.style.display = "none";
            lower_div.appendChild(splits_display);
          };
          const add_initial_empty_stopwatch_display = () => {
            const lower_div = document.getElementById("lower_div");

            const stopwatch_display = document.createElement("div");
            stopwatch_display.id = "stopwatch_display";
            stopwatch_display.style.display = "none";
            lower_div.appendChild(stopwatch_display);
          };
          const add_initial_empty_video_display = () => {
            const lower_div = document.getElementById("lower_div");

            const video_display = document.createElement("div");
            video_display.id = "video_display";
            video_display.style.display = "none";
            lower_div.appendChild(video_display);
          };
          const add__app_settings_display = () => {
            const lower_div = document.getElementById("lower_div");

            const app_settings_display = document.createElement("div");
            app_settings_display.id = "app_settings_display";
            app_settings_display.style.display = "none";
            lower_div.appendChild(app_settings_display);

            const app_settings_table = document.createElement("table");
            app_settings_table.id = "app_settings_table";
            app_settings_display.appendChild(app_settings_table);

            let app_settings_row = document.createElement("tr");
            app_settings_table.appendChild(app_settings_row);

            let app_settings_data = document.createElement("td");
            app_settings_data.classList.add("app_setting_label");
            app_settings_row.appendChild(app_settings_data);
            const coach_settings_label = document.createElement("label");
            coach_settings_label.innerText = "Coach ID:";
            coach_settings_label.id = "coach_settings_label";
            coach_settings_label.for = "coach_settings_box";
            app_settings_data.appendChild(coach_settings_label);

            app_settings_data = document.createElement("td");
            app_settings_row.appendChild(app_settings_data);
            app_settings_data.colSpan = 2;
            const coach_settings_box = document.createElement("input");
            coach_settings_box.type = "text";
            coach_settings_box.id = "coach_settings_box";
            coach_settings_box.name = "coach_settings_box";
            coach_settings_box.value = COACH_ID;
            coach_settings_box.readOnly = true;
            coach_settings_box.disabled = true;
            coach_settings_box.style.width = "100%";
            app_settings_data.appendChild(coach_settings_box);

            app_settings_row = document.createElement("tr");
            app_settings_table.appendChild(app_settings_row);

            app_settings_data = document.createElement("td");
            app_settings_data.classList.add("app_setting_label");
            app_settings_row.appendChild(app_settings_data);
            const first_setting_label = document.createElement("label");
            first_setting_label.innerText = "Seconds to display split:";
            first_setting_label.id = "split_setting_label";
            first_setting_label.for = "split_display_setting";
            app_settings_data.appendChild(first_setting_label);

            app_settings_data = document.createElement("td");
            app_settings_row.appendChild(app_settings_data);
            const first_setting_number_input = document.createElement("input");
            first_setting_number_input.type = "number";
            first_setting_number_input.id = "split_display_setting";
            first_setting_number_input.name = "split_display_setting";
            first_setting_number_input.min = 1;
            first_setting_number_input.max = 100;
            first_setting_number_input.value = MILLS_TO_DISPLAY_SPLITS / 1000;
            first_setting_number_input.addEventListener(
              "change",
              displaySplitTimeChanged
            );
            app_settings_data.appendChild(first_setting_number_input);

            app_settings_data = document.createElement("td");
            app_settings_row.appendChild(app_settings_data);
            const return_splits_to_default_button =
              document.createElement("button");
            return_splits_to_default_button.type = "button";
            return_splits_to_default_button.innerText = "Default";
            return_splits_to_default_button.classList.add("btn");
            return_splits_to_default_button.classList.add("btn-primary");
            return_splits_to_default_button.classList.add("nearly_full_width");
            return_splits_to_default_button.addEventListener(
              "click",
              returnSplitTimeToDefault
            );
            app_settings_data.appendChild(return_splits_to_default_button);

            app_settings_row = document.createElement("tr");
            app_settings_table.appendChild(app_settings_row);

            app_settings_data = document.createElement("td");
            app_settings_data.classList.add("app_setting_label");
            app_settings_row.appendChild(app_settings_data);
            const second_setting_label = document.createElement("label");
            second_setting_label.innerText =
              "Seconds to display stopwatch result:";
            second_setting_label.id = "stopwatch_setting_label";
            second_setting_label.for = "stopwatch_display_setting";
            app_settings_data.appendChild(second_setting_label);

            app_settings_data = document.createElement("td");
            app_settings_row.appendChild(app_settings_data);
            const stopwatch_display_setting = document.createElement("input");
            stopwatch_display_setting.type = "number";
            stopwatch_display_setting.id = "stopwatch_display_setting";
            stopwatch_display_setting.name = "stopwatch_display_setting";
            stopwatch_display_setting.min = 1;
            stopwatch_display_setting.max = 100;
            stopwatch_display_setting.value = MILLS_TO_DISPLAY_STOPWATCH / 1000;
            stopwatch_display_setting.addEventListener(
              "change",
              displayStopwatchTimeChanged
            );
            app_settings_data.appendChild(stopwatch_display_setting);

            app_settings_data = document.createElement("td");
            app_settings_row.appendChild(app_settings_data);
            const return_stopwatch_to_default_button =
              document.createElement("button");
            return_stopwatch_to_default_button.type = "button";
            return_stopwatch_to_default_button.innerText = "Default";
            return_stopwatch_to_default_button.classList.add("btn");
            return_stopwatch_to_default_button.classList.add("btn-primary");
            return_stopwatch_to_default_button.classList.add(
              "nearly_full_width"
            );
            return_stopwatch_to_default_button.addEventListener(
              "click",
              returnStopwatchTimeToDefault
            );
            app_settings_data.appendChild(return_stopwatch_to_default_button);
          };

          add_controls_div();
          add_initial_empty_lanes_display();
          add_initial_empty_splits_display();
          add_initial_empty_stopwatch_display();
          add_initial_empty_video_display();
          add__app_settings_display();
        };

        clearScreenOfBeginningControls();
        buildUpperDisplay();
        buildLowerDisplay();
        setInterval(newSetClock, MILLS_TO_UPDATE_CLOCK);
        OpenForConnections();
      }

      function newSetClock() {
        checkOrientation();
        if (isNaN(time_delta)) {
          clock.innerText = "00:00";
          return "";
        }
        let now = Date.now();
        let curr = now;
        curr += time_delta + additional_time_delta;
        let display_time = new Date(curr);
        clock.innerText = `${checkTime(display_time.getMinutes())}:${checkTime(
          display_time.getSeconds()
        )}`;

        const lanes = Object.keys(LANES);
        lanes.sort((a, b) => parseInt(a) - parseInt(b));

        lanes.forEach((lane_number) => {
          if (LANES[lane_number].connected) {
            const lane_panel = LANES[lane_number].lane_panel;
            const split_panel = LANES[lane_number].split_panel;

            const lane_clock = getLaneClock(lane_panel);
            display_time =
              LANES[lane_number].lane_clock.getDisplayTimeFromTime(now);
            lane_clock.innerText = display_time;

            const split_clock = getLaneClock(split_panel);
            split_clock.innerText = display_time;

            lanes.forEach((lane) =>
              processTimeForLane(lane, lane_clock.innerText)
            );

            if (LANES[lane_number].stopwatch.running) {
              let time_elapsed = now - LANES[lane_number].stopwatch.start_time;
              let stopwatch = document.getElementById(
                "lane" + lane_number + "_stopwatch"
              );
              time_elapsed = new Date(time_elapsed);
              let milis = time_elapsed.getMilliseconds();
              milis = truncateToHundreth(milis);
              milis < 10 ? (milis = "0" + milis) : (milis = milis + "");
              stopwatch.innerText = `${checkTime(
                time_elapsed.getMinutes()
              )}:${checkTime(time_elapsed.getSeconds())}.${milis}`;
            }
          }
        });
        fitText(clock, true);
        fitText(document.getElementById("room_code_text"));
        fitText(document.getElementById("room_code_text_above"));
        processGreenChanges();
      }

      function checkOrientation() {
        if (
          screen.orientation.type != last_orientation ||
          screen.orientation.type.includes("portrait")
        ) {
          last_orientation = screen.orientation.type;
          setOrientation(last_orientation);
        }
      }

      function setOrientation(type) {
        if (type.includes("portrait")) {
          document.getElementById("container").style.display = "none";
          document.getElementById("rotate").style.display = "";
        } else {
          document.getElementById("container").style.display = "";
          document.getElementById("rotate").style.display = "none";
        }
      }

      function requestFullScreen(div_to_fullscreen) {
        //request Full Screen
        if (typeof SKIP_FULLSCREEN === "undefined") return;
        if (SKIP_FULLSCREEN == 1) return;

        if (div_to_fullscreen.requestFullscreen) {
          div_to_fullscreen.requestFullscreen();
        } else if (div_to_fullscreen.webkitRequestFullscreen) {
          /* Safari */
          div_to_fullscreen.webkitRequestFullscreen();
        } else if (div_to_fullscreen.msRequestFullscreen) {
          /* IE11 */
          div_to_fullscreen.msRequestFullscreen();
        }
      }

      function OpenForConnections() {
        socket = new WebSocket(
          "wss://mjim68pp6h.execute-api.us-east-2.amazonaws.com/production/"
        );

        socket.onopen = (event) => {
          newGetTimeDelta();
          let connections_div = document.getElementById("connections_div");
          connections_div.innerText =
            "Sever connection established. Setting as coach...";
          let set_connection_type_data = {
            action: "setConnectionType",
            type: "coach",
          };
          socket.send(JSON.stringify(set_connection_type_data));
          connections_div.innerText = "Creating room...";
          let data = { action: "createRoom" };
          socket.send(JSON.stringify(data));

          setInterval(newGetTimeDelta, MILLS_TO_SYNC_WITH_SERVER);
        };

        socket.onerror = (error) => {
          let connections_div = document.getElementById("connections_div");
          connections_div.innerHTML = "Connection Error";
        };

        socket.onmessage = (event) => {
          let data = JSON.parse(event.data);
          if (data?.message == "Internal server error")
            _processServerError(event.data);
          else {
            if (data.type) {
              switch (data.type) {
                case "RoomCreated":
                  _processRoomCreation(data.data);
                  break;
                case "LaneConnect":
                  _processLaneConnection(data.laneNumber);
                  break;
                case "LaneDisconnect":
                  _processLaneDisconnect(data.laneNumber);
                  break;
                case "resetClock":
                  newSyncClock(data);
                  break;
                case "timestamp":
                  dealWithTimeStamp(data);
                  break;
                case "coachVideoList":
                  dealWithCoachVideoList(data.coachVideos);
                  break;
              }
            }
          }
        };
      }

      function newGetTimeDelta() {
        let data = { action: "getTime", initial_time: Date.now() };
        socket.send(JSON.stringify(data));
      }

      function _processServerError(data) {}

      function _processRoomCreation(data) {
        let room_code_text = document.getElementById("room_code_text");
        room_code_text.innerHTML = room_code_text.innerHTML.replace(
          "---",
          data.room_key
        );
        roomKey = data.room_key;
        let connections_div = document.getElementById("connections_div");
        connections_div.innerText = "Waiting for lanes to connect.";

        let buttons = document.getElementsByTagName("button");
        for (i = 0; i < buttons.length; i++) {
          buttons[i].disabled = false;
        }
      }

      function _processLaneConnection(laneNumber) {
        let lane = parseInt(laneNumber);
        LANES[lane] = {
          connected: true,
          lane_clock: new LaneClock(time_delta, additional_time_delta),
        };
        UpdateLaneConnections();
        LANES[lane].lane_panel = createLaneTable(lane);
        LANES[lane].split_panel = createSplitTable(lane);
        LANES[lane].stopwatch_panel = createStopWatchTable(lane);
        const lanes_display = document.getElementById("lanes_display");
        while (lanes_display.children.length > 0)
          lanes_display.children[0].remove();
        const splits_display = document.getElementById("splits_display");
        while (splits_display.children.length > 0)
          splits_display.children[0].remove();
        const stopwatch_display = document.getElementById("stopwatch_display");
        while (stopwatch_display.children.length > 0)
          stopwatch_display.children[0].remove();
        let lanes = Object.keys(LANES);
        lanes.sort((a, b) => parseInt(a) - parseInt(b));
        lanes.forEach((lane) => {
          lanes_display.appendChild(LANES[lane].lane_panel);
          splits_display.appendChild(LANES[lane].split_panel);
          stopwatch_display.appendChild(LANES[lane].stopwatch_panel);
        });
        syncClocks();
      }

      function _processLaneDisconnect(laneNumber) {
        let lane = parseInt(laneNumber);
        LANES[lane].connected = false;
        UpdateLaneConnections();
        LANES[lane].lane_panel.classList.remove("connectedLane");
        LANES[lane].lane_panel.classList.add("disconnected_lane");
        LANES[lane].split_panel.classList.remove("connectedLane");
        LANES[lane].split_panel.classList.add("disconnected_lane");
        LANES[lane].stopwatch_panel.classList.remove("connectedLane");
        LANES[lane].stopwatch_panel.classList.add("disconnected_lane");
      }

      function newSyncClock(data) {
        let now = Date.now();
        let adjusted_time = new Date(now);

        adjusted_time.setMinutes(data.minutes);
        adjusted_time.setSeconds(data.seconds);
        adjusted_time.setMilliseconds(0);
        time_delta = 0 - (now - adjusted_time.getTime());
      }

      function dealWithTimeStamp(data) {
        let current_time = Date.now();
        let trip_time = current_time - data.initial_time;
        time_delta = data.timestamp - current_time + Math.floor(trip_time / 2);
        const keys = Object.keys(LANES);
        keys.forEach((lane_number) => {
          LANES[lane_number].lane_clock.time_delta = time_delta;
        });
      }

      function UpdateLaneConnections() {
        let keys = Object.keys(LANES);
        let connections_screen = document.getElementById("connections_div");
        while (connections_screen.firstChild) {
          connections_screen.removeChild(connections_screen.firstChild);
        }

        keys.sort((a, b) => parseInt(a) - parseInt(b));

        keys.forEach((key) => {
          let lane = key;

          if (LANES[lane].connected) {
            connections_screen.appendChild(_getNewLaneButton(lane));
          } else {
            connections_screen.appendChild(_getNewDisConnectedLaneButton(lane));
          }
        });
      }

      function _getNewLaneButton(lane_number) {
        let lane_div = document.createElement("div");
        let lane_p = document.createElement("p");

        lane_p.innerText = lane_number;
        lane_p.classList.add("pfill");
        lane_div.appendChild(lane_p);
        lane_div.classList.add("connectedLane");
        lane_div.classList.add("lane");
        lane_div.id = "lane_" + lane_number;
        return lane_div;
      }

      function _getNewDisConnectedLaneButton(lane_number) {
        let lane_div = document.createElement("div");
        let lane_p = document.createElement("p");

        lane_p.innerText = lane_number;
        lane_p.classList.add("pfill");
        lane_div.appendChild(lane_p);
        lane_div.classList.add("disconnected");
        lane_div.classList.add("lane");
        lane_div.id = "lane_" + lane_number;
        return lane_div;
      }

      function checkTime(i) {
        if (i < 10) return `0${i}`;
        return i + "";
      }

      async function requestScreenLock() {
        if ("wakeLock" in navigator) {
          try {
            wakeLock = await awaitnavigator.wakeLock.request("screen");
            document.addEventListener("visibilitychange", async () => {
              if (wakeLock !== null && document.visibilityState === "visible") {
                wakeLock = await navigator.wakeLock.request("screen");
              }
            });
          } catch (err) {
            //don't need to do anything if it doesn't work
          }
        }
      }

      function setToZero() {
        let temp = Date.now();

        let split_clock_text = clock.innerText.split(":");
        let minutes = parseInt(split_clock_text[0]);
        let seconds = parseInt(split_clock_text[1]);

        let running_time = new Date(temp + time_delta);
        let new_time = new Date(running_time);
        new_time.setMinutes(minutes);
        new_time.setSeconds(0);
        new_time.setMilliseconds(0);

        let diff = new_time.getTime() - running_time.getTime();
        sendSyncClocksCommand(diff);
        const lanes = Object.keys(LANES);
        lanes.forEach((lane) => {
          const lane_clock = LANES[lane].lane_clock;
          if (lane_clock.additional_time_delta == additional_time_delta)
            lane_clock.additional_time_delta = diff;
        });
        additional_time_delta = diff;
      }

      function sendSyncClocksCommand(diff) {
        let data = {
          action: "syncClocks",
          additional_time_delta: diff,
          roomKey: roomKey,
        };

        socket.send(JSON.stringify(data));
      }

      function addOneMinute() {
        additional_time_delta += 60000;
        sendSyncClocksCommand(additional_time_delta);

        const lanes = Object.keys(LANES);
        lanes.forEach((lane) => {
          const lane_clock = LANES[lane].lane_clock;
          if (lane_clock.additional_time_delta == additional_time_delta - 60000)
            lane_clock.additional_time_delta += 60000;
        });
      }

      function subtractOneMinute() {
        additional_time_delta -= 60000;
        sendSyncClocksCommand(additional_time_delta);

        const lanes = Object.keys(LANES);
        lanes.forEach((lane) => {
          const lane_clock = LANES[lane].lane_clock;
          if (lane_clock.additional_time_delta == additional_time_delta + 60000)
            lane_clock.additional_time_delta -= 60000;
        });
      }

      function syncClocks() {
        sendSyncClocksCommand(additional_time_delta);
      }

      function sendInfo() {
        data = {
          action: "sendMessage",
          roomKey: roomKey,
          message: {
            1: [
              { name: "Swimmer 1", time: "00:30", description: "100 FR" },
              { name: "", time: "00:35", description: "100 FR" },
              { name: "", time: "00:40", description: "100 FR" },
              { name: "", time: "00:45", description: "100 FR" },
              { name: "", time: "01:00", description: "100 FR" },
              { name: "", time: "01:05", description: "100 FR" },
              { name: "", time: "01:10", description: "100 FR" },
              { name: "", time: "01:15", description: "100 FR" },
            ],
          },
        };

        socket.send(JSON.stringify(data));
      }

      function truncateToHundreth(n) {
        n = n.toString();
        switch (n.length) {
          case 0:
            return 0;
            break;
          case 1:
            return 0;
            break;
          case 2:
            return parseInt(n.substring(0, 1));
            break;
          case 3:
            return parseInt(n.substring(0, 2));
        }
      }

      function getSplit(lane_number) {
        let curr = Date.now();
        curr +=
          LANES[lane_number].lane_clock.time_delta +
          LANES[lane_number].lane_clock.additional_time_delta;
        let split = new Date(curr);
        let milis = split.getMilliseconds();
        milis = truncateToHundreth(milis);
        milis < 10 ? (milis = "0" + milis) : (milis = milis + "");
        split = `${checkTime(split.getSeconds())}.${milis}`;
        return split;
      }

      async function Split(e) {
        setTimeout(() => {
          let process = true;
          if (e.type === "mousedown") {
            if (Date.now - last_touch < 20) {
              process = false;
            }
          } else {
            last_touch = Date.now();
          }
          if (process) {
            const lane_number = parseInt(
              e.srcElement.id.replace("lane", "").replace("_split_button")
            );
            let split = getSplit(lane_number);
            const split_p = document.getElementById(
              "lane" + lane_number + "_split"
            );
            split_p.innerText = split;

            socket.send(
              JSON.stringify({
                action: "split",
                split: split,
                lane_to_send_to: lane_number,
                roomKey: roomKey,
                mills_to_display_splits: MILLS_TO_DISPLAY_SPLITS,
              })
            );
          }
        }, 1);
      }

      function createLaneTable(lane_number) {
        const lanes_display = document.getElementById("lanes_display");

        let active_lane = LANES[lane_number].connected;
        const lane_div = document.createElement("div");
        lane_div.id = "lane" + lane_number;
        lane_div.classList.add("lane_display_container");
        active_lane
          ? lane_div.classList.add("active_lane")
          : lane_div.classList.add("disconnected_lane");

        const addLaneLabel = () => {
          const lane_label = document.createElement("h5");
          lane_label.id = "lane" + lane_number + "_label";
          lane_label.classList.add("lane_label");
          lane_label.innerText = "Lane " + lane_number;
          lane_div.appendChild(lane_label);
        };
        const addLaneClock = () => {
          const lane_clock = document.createElement("h3");
          lane_clock.id = "lane" + lane_number + "clock";
          lane_clock.classList.add("lane_clock");
          lane_clock.innerText = LANES[lane_number].lane_clock.getDisplayTime();
          lane_div.appendChild(lane_clock);

          LANES[lane_number].lane_clock_display;
        };
        const addStopStartControls = () => {
          const lane_controls_major_div = document.createElement("div");
          lane_controls_major_div.id =
            "lane" + lane_number + "_controls_major_lane" + lane_number;
          lane_controls_major_div.classList.add("lane_controls");
          lane_div.appendChild(lane_controls_major_div);

          const pause_button = document.createElement("button");
          pause_button.type = "button";
          pause_button.id = "lane" + lane_number + "_pause_button";
          pause_button.classList.add("btn");
          pause_button.classList.add("btn-warning");
          pause_button.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" fill="#000000" height="35" width="35" version="1.1" id="Capa_1" viewBox="0 0 512 512" xml:space="preserve">
                  <path d="M256,0C114.617,0,0,114.615,0,256s114.617,256,256,256s256-114.615,256-256S397.383,0,256,0z M224,320  c0,8.836-7.164,16-16,16h-32c-8.836,0-16-7.164-16-16V192c0-8.836,7.164-16,16-16h32c8.836,0,16,7.164,16,16V320z M352,320  c0,8.836-7.164,16-16,16h-32c-8.836,0-16-7.164-16-16V192c0-8.836,7.164-16,16-16h32c8.836,0,16,7.164,16,16V320z"></path>
                </svg>`;
          lane_controls_major_div.appendChild(pause_button);

          const stop_button = document.createElement("button");
          stop_button.type = "button";
          stop_button.id = "lane" + lane_number + "_stop_button";
          stop_button.classList.add("btn");
          stop_button.classList.add("btn-danger");
          stop_button.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" height="35" width="35" version="1.1" id="Capa_1" viewBox="0 0 30.05 30.05" xml:space="preserve">
                  <g>
                    <path style="fill: #030104" d="M18.993,10.688h-7.936c-0.19,0-0.346,0.149-0.346,0.342v8.022c0,0.189,0.155,0.344,0.346,0.344   h7.936c0.19,0,0.344-0.154,0.344-0.344V11.03C19.336,10.838,19.183,10.688,18.993,10.688z"></path>
                    <path style="fill: #030104" d="M15.026,0C6.729,0,0.001,6.726,0.001,15.025S6.729,30.05,15.026,30.05   c8.298,0,15.023-6.726,15.023-15.025S23.324,0,15.026,0z M15.026,27.54c-6.912,0-12.516-5.604-12.516-12.515   c0-6.914,5.604-12.517,12.516-12.517c6.913,0,12.514,5.603,12.514,12.517C27.54,21.936,21.939,27.54,15.026,27.54z"></path>
                  </g>
                </svg>`;
          lane_controls_major_div.appendChild(stop_button);
        };
        const addLaneClockControls = () => {
          const lane_clock_controls_div = document.createElement("div");
          lane_clock_controls_div.id =
            "lane" + lane_number + "_lane_clock_controls_div";
          lane_clock_controls_div.classList.add("lane_clock_controls");
          lane_div.appendChild(lane_clock_controls_div);

          const edit_lane_control_button = document.createElement("button");
          edit_lane_control_button.id =
            "lane" + lane_number + "_edit_lane_control_button";
          edit_lane_control_button.classList.add("btn");
          edit_lane_control_button.classList.add("btn-success");
          edit_lane_control_button.innerText = "Clock Controls";
          lane_clock_controls_div.appendChild(edit_lane_control_button);

          const start_controls_div = document.createElement("div");
          start_controls_div.id = "lane" + lane_number + "_start_controls";
          start_controls_div.classList.add("lane_controls");
          start_controls_div.style.display = "none";
          lane_div.appendChild(start_controls_div);

          const start_on_top_button = document.createElement("button");
          start_on_top_button.type = "button";
          start_on_top_button.classList.add("btn");
          start_on_top_button.classList.add("btn-success");
          start_on_top_button.innerText = "Start on :00";
          start_controls_div.appendChild(start_on_top_button);

          const start_on_thirty_button = document.createElement("button");
          start_on_thirty_button.type = "button";
          start_on_thirty_button.classList.add("btn");
          start_on_thirty_button.classList.add("btn-success");
          start_on_thirty_button.innerText = "Start on :30";
          start_controls_div.appendChild(start_on_thirty_button);

          const lane_controls_subtract_time_div = document.createElement("div");
          lane_controls_subtract_time_div.id =
            "lane_controls_subtract_time_lane" + lane_number;
          lane_controls_subtract_time_div.classList.add("lane_controls");
          lane_controls_subtract_time_div.style.display = "none";
          lane_div.appendChild(lane_controls_subtract_time_div);

          const subtract_min_button = document.createElement("button");
          subtract_min_button.type = "button";
          subtract_min_button.classList.add("btn");
          subtract_min_button.classList.add("btn-primary");
          subtract_min_button.innerText = "-1:00";
          lane_controls_subtract_time_div.appendChild(subtract_min_button);

          const subtract_ten_button = document.createElement("button");
          subtract_ten_button.type = "button";
          subtract_ten_button.classList.add("btn");
          subtract_ten_button.classList.add("btn-primary");
          subtract_ten_button.innerText = "-:10";
          lane_controls_subtract_time_div.appendChild(subtract_ten_button);

          const subtract_one_button = document.createElement("button");
          subtract_one_button.type = "button";
          subtract_one_button.classList.add("btn");
          subtract_one_button.classList.add("btn-primary");
          subtract_one_button.innerText = "-:01";
          lane_controls_subtract_time_div.appendChild(subtract_one_button);

          const lane_controls_tare_div = document.createElement("div");
          lane_controls_tare_div.id = "lane_controls_tare_lane" + lane_number;
          lane_controls_tare_div.classList.add("lane_controls");
          lane_controls_tare_div.style.display = "none";
          lane_div.appendChild(lane_controls_tare_div);

          const tare_button = document.createElement("button");
          tare_button.type = "button";
          tare_button.classList.add("btn");
          tare_button.classList.add("btn-primary");
          tare_button.innerText = "set to :00";
          lane_controls_tare_div.appendChild(tare_button);

          const lane_controls_addtime_div = document.createElement("div");
          lane_controls_addtime_div.id =
            "lane_controls_add_time_lane" + lane_number;
          lane_controls_addtime_div.classList.add("lane_controls");
          lane_controls_addtime_div.style.display = "none";
          lane_div.appendChild(lane_controls_addtime_div);

          const add_min_button = document.createElement("button");
          add_min_button.type = "button";
          add_min_button.classList.add("btn");
          add_min_button.classList.add("btn-primary");
          add_min_button.innerText = "+1:00";
          lane_controls_addtime_div.appendChild(add_min_button);

          const add_ten_button = document.createElement("button");
          add_ten_button.type = "button";
          add_ten_button.classList.add("btn");
          add_ten_button.classList.add("btn-primary");
          add_ten_button.innerText = "+:10";
          lane_controls_addtime_div.appendChild(add_ten_button);

          const add_one_button = document.createElement("button");
          add_one_button.type = "button";
          add_one_button.classList.add("btn");
          add_one_button.classList.add("btn-primary");
          add_one_button.innerText = "+:01";
          lane_controls_addtime_div.appendChild(add_one_button);
        };
        const addDisplays = () => {
          const next_up_div = document.createElement("div");
          next_up_div.id = "lane" + lane_number + "_next_up_div";
          next_up_div.classList.add("next_up_display");
          lane_div.appendChild(next_up_div);

          next_up_div.appendChild(document.createElement("p"));
          next_up_div.appendChild(document.createElement("p"));

          const next_table = document.createElement("table");
          next_table.id = "lane" + lane_number + "_next_table";
          next_table.classList.add("lane_table");
        };

        addLaneLabel();
        addLaneClock();
        addStopStartControls();
        addLaneClockControls();
        addDisplays();

        return lane_div;
      }

      function createSplitTable(lane_number) {
        const lane_split_panel = document.createElement("div");
        lane_split_panel.id = "lane" + lane_number + "_split_panel";
        let active_lane = LANES[lane_number].connected;
        active_lane
          ? lane_split_panel.classList.add("active_lane")
          : lane_split_panel.classList.add("disconnected_lane");
        lane_split_panel.classList.add("lane_split_panel");

        const lane_label = document.createElement("h5");
        lane_label.id = "lane" + lane_number + "_label";
        lane_label.classList.add("lane_label");
        lane_label.innerText = "Lane " + lane_number;
        lane_split_panel.appendChild(lane_label);

        const lane_clock = document.createElement("h3");
        lane_clock.id = "lane" + lane_number + "clock";
        lane_clock.classList.add("lane_clock");
        lane_clock.innerText = LANES[lane_number].lane_clock.getDisplayTime();
        lane_split_panel.appendChild(lane_clock);

        const split_button = document.createElement("button");
        split_button.id = "lane" + lane_number + "_split_button";
        split_button.classList.add("btn");
        split_button.classList.add("btn-primary");
        split_button.classList.add("split_button");
        split_button.innerText = "Lane " + lane_number + " Split";
        split_button.addEventListener("mousedown", Split);
        split_button.addEventListener("touchstart", Split);
        lane_split_panel.appendChild(split_button);

        const split_p = document.createElement("p");
        split_p.id = "lane" + lane_number + "_split";
        split_p.innerText = "00.00";
        split_p.classList.add("split");
        lane_split_panel.appendChild(split_p);

        return lane_split_panel;
      }

      function createStopWatchTable(lane_number) {
        LANES[lane_number].stopwatch = { running: false };
        const lane_stopwatch_panel = document.createElement("div");
        lane_stopwatch_panel.id = "lane" + lane_number + "_stopwatch_panel";
        let active_lane = LANES[lane_number].connected;
        active_lane
          ? lane_stopwatch_panel.classList.add("active_lane")
          : lane_stopwatch_panel.classList.add("disconnected_lane");
        lane_stopwatch_panel.classList.add("stopwatch_split_panel");

        const lane_label = document.createElement("h5");
        lane_label.id = "lane" + lane_number + "_label";
        lane_label.classList.add("lane_label");
        lane_label.innerText = "Lane " + lane_number;
        lane_stopwatch_panel.appendChild(lane_label);

        const stopwatch = document.createElement("div");
        stopwatch.id = "lane" + lane_number + "_stopwatch";
        stopwatch.classList.add("stopwatch");
        stopwatch.innerText = "00:00.00";
        lane_stopwatch_panel.appendChild(stopwatch);

        const start_stop_div = document.createElement("div");
        start_stop_div.classList.add("big_split_button_div");
        lane_stopwatch_panel.appendChild(start_stop_div);

        const start_stopwatch_button = document.createElement("button");
        start_stopwatch_button.type = "button";
        start_stopwatch_button.id = "lane" + lane_number + "_start_button";
        start_stopwatch_button.innerText = "Start";
        start_stopwatch_button.classList.add("btn");
        start_stopwatch_button.classList.add("btn-success");
        start_stopwatch_button.classList.add("stopwatch_button");
        start_stopwatch_button.classList.add("big_split_button");
        start_stopwatch_button.addEventListener("click", startStopWatchClicked);
        start_stop_div.appendChild(start_stopwatch_button);

        const stop_stopwatch_button = document.createElement("button");
        stop_stopwatch_button.type = "button";
        stop_stopwatch_button.id = "lane" + lane_number + "_stop_button";
        stop_stopwatch_button.innerText = "Stop";
        stop_stopwatch_button.classList.add("btn");
        stop_stopwatch_button.classList.add("btn-danger");
        stop_stopwatch_button.classList.add("stopwatch_button");
        stop_stopwatch_button.classList.add("big_split_button");
        stop_stopwatch_button.style.display = "none";
        stop_stopwatch_button.addEventListener("click", stopStopWatchClicked);
        start_stop_div.appendChild(stop_stopwatch_button);

        const below_start_stop_div = document.createElement("div");
        below_start_stop_div.classList.add("buttons_next_to_each_other");
        lane_stopwatch_panel.appendChild(below_start_stop_div);

        const split_stopwatch_button = document.createElement("button");
        split_stopwatch_button.type = "button";
        split_stopwatch_button.id =
          "lane" + lane_number + "_stopwatch_split_button";
        split_stopwatch_button.innerText = "Split";
        split_stopwatch_button.classList.add("btn");
        split_stopwatch_button.classList.add("btn-primary");
        split_stopwatch_button.classList.add("stopwatch_button");
        split_stopwatch_button.disabled = true;
        split_stopwatch_button.addEventListener("click", splitStopWatchClicked);
        below_start_stop_div.appendChild(split_stopwatch_button);

        const clear_stopwatch_button = document.createElement("button");
        clear_stopwatch_button.type = "button";
        clear_stopwatch_button.id = "lane" + lane_number + "_clear_button";
        clear_stopwatch_button.innerText = "Clear";
        clear_stopwatch_button.classList.add("btn");
        clear_stopwatch_button.classList.add("btn-primary");
        clear_stopwatch_button.classList.add("stopwatch_button");
        clear_stopwatch_button.addEventListener("click", clearStopWatchClicked);
        below_start_stop_div.appendChild(clear_stopwatch_button);

        const stopwatch_split_display = document.createElement("div");
        stopwatch_split_display.innerText = "0:00.00";
        stopwatch_split_display.style.visibility = "hidden";
        stopwatch_split_display.classList.add("stopwatch_split");
        lane_stopwatch_panel.appendChild(stopwatch_split_display);

        return lane_stopwatch_panel;
      }

      function getLaneClock(lane_panel) {
        return lane_panel.children[1];
      }

      class LaneClock {
        constructor(time_delta, additional_time_delta) {
          this.time_delta = time_delta;
          this.additional_time_delta = additional_time_delta;
        }

        getDisplayTime() {
          if (isNaN(this.time_delta)) {
            return "00:00";
          }
          let curr = Date.now();
          curr += this.time_delta + this.additional_time_delta;
          let display_time = new Date(curr);
          let text = `${checkTime(display_time.getMinutes())}:${checkTime(
            display_time.getSeconds()
          )}`;
          return text;
        }

        getDisplayTimeFromTime(time) {
          time += this.time_delta + this.additional_time_delta;
          let display_time = new Date(time);
          let text = `${checkTime(display_time.getMinutes())}:${checkTime(
            display_time.getSeconds()
          )}`;
          return text;
        }
      }

      function optionsButtonClicked() {
        options_button_just_clicked = true;
        let options_div = document.getElementById("options_div");
        let displaying = options_div.style.display;
        if (options_div.style.display == "") {
          options_div.style.display = "none";
          const modal = document.getElementById("modal");
          modal.remove();
        } else {
          const modal = document.createElement("modal");
          modal.id = "modal";
          modal.style.width = "100vw";
          modal.style.height = "100vh";
          modal.style.position = "absolute";
          modal.style.top = "0";
          modal.style.left = "0";
          modal.addEventListener("click", clickAnywhere);
          options_div.style.display = "";
          const body = document.getElementsByTagName("body");
          body[0].appendChild(modal);
        }
      }

      function switchToSplitMode() {
        removeVideoPlayerPanel();
        removeModal();
        document.getElementById("options_div").style.display = "none";

        document.getElementById("sendoff_controls_panel").style.display =
          "none";
        document.getElementById("split_controls_panel").style.display = "";
        document.getElementById("stopwatch_controls_panel").style.display =
          "none";
        document.getElementById("video_controls_panel").style.display = "none";
        document.getElementById("app_settings_controls_panel").style.display =
          "none";

        document.getElementById("lanes_display").style.display = "none";
        document.getElementById("splits_display").style.display = "";
        document.getElementById("stopwatch_display").style.display = "none";
        document.getElementById("video_display").style.display = "none";
        document.getElementById("app_settings_display").style.display = "none";
      }

      function switchToSendoffMode() {
        removeVideoPlayerPanel();
        removeModal();
        document.getElementById("options_div").style.display = "none";

        document.getElementById("sendoff_controls_panel").style.display = "";
        document.getElementById("split_controls_panel").style.display = "none";
        document.getElementById("stopwatch_controls_panel").style.display =
          "none";
        document.getElementById("video_controls_panel").style.display = "none";
        document.getElementById("app_settings_controls_panel").style.display =
          "none";

        document.getElementById("lanes_display").style.display = "";
        document.getElementById("splits_display").style.display = "none";
        document.getElementById("stopwatch_display").style.display = "none";
        document.getElementById("video_display").style.display = "none";
        document.getElementById("app_settings_display").style.display = "none";
      }

      function switchToStopwatchMode() {
        removeVideoPlayerPanel();
        removeModal();
        document.getElementById("options_div").style.display = "none";

        document.getElementById("sendoff_controls_panel").style.display =
          "none";
        document.getElementById("split_controls_panel").style.display = "none";
        document.getElementById("stopwatch_controls_panel").style.display = "";
        document.getElementById("video_controls_panel").style.display = "none";
        document.getElementById("app_settings_controls_panel").style.display =
          "none";

        document.getElementById("lanes_display").style.display = "none";
        document.getElementById("splits_display").style.display = "none";
        document.getElementById("stopwatch_display").style.display = "";
        document.getElementById("video_display").style.display = "none";
        document.getElementById("app_settings_display").style.display = "none";
      }

      function switchToVideoMode() {
        removeVideoPlayerPanel();
        removeModal();
        document.getElementById("options_div").style.display = "none";

        document.getElementById("sendoff_controls_panel").style.display =
          "none";
        document.getElementById("split_controls_panel").style.display = "none";
        document.getElementById("stopwatch_controls_panel").style.display =
          "none";
        document.getElementById("video_controls_panel").style.display = "";
        document.getElementById("app_settings_controls_panel").style.display =
          "none";

        document.getElementById("lanes_display").style.display = "none";
        document.getElementById("splits_display").style.display = "none";
        document.getElementById("stopwatch_display").style.display = "none";
        let video_display = document.getElementById("video_display");
        video_display.style.display = "";
        document.getElementById("app_settings_display").style.display = "none";

        const message = document.createElement("p");
        message.style.color = "white";
        message.innerText = "Loading videos...";
        video_display.appendChild(message);

        let set_connection_type_data = {
          action: "getCoachVideos",
          coachID: COACH_ID,
        };
        socket.send(JSON.stringify(set_connection_type_data));
      }

      function switchToAppSettings() {
        removeVideoPlayerPanel();
        removeModal();
        document.getElementById("options_div").style.display = "none";

        document.getElementById("sendoff_controls_panel").style.display =
          "none";
        document.getElementById("split_controls_panel").style.display = "none";
        document.getElementById("stopwatch_controls_panel").style.display =
          "none";
        document.getElementById("video_controls_panel").style.display = "none";
        document.getElementById("app_settings_controls_panel").style.display =
          "";

        document.getElementById("lanes_display").style.display = "none";
        document.getElementById("splits_display").style.display = "none";
        document.getElementById("stopwatch_display").style.display = "none";
        document.getElementById("video_display").style.display = "none";
        document.getElementById("app_settings_display").style.display = "";
      }

      function fitText(element, ignore_width = false) {
        if (element.id == "room_code_text_above") {
          let stop = 1;
        }
        let RESIZE = false;
        let div = element.parentElement;

        let text_size = 3;

        if (!ignore_width) {
          if (element.old_height == undefined || element.old_width == undefined)
            RESIZE = true;
          else if (
            element.old_height != div.clientHeight ||
            element.old_width != div.clientWidth
          )
            RESIZE = true;

          if (RESIZE) {
            element.style.fontSize = text_size + "px";
            while (
              div.clientHeight > element.clientHeight &&
              div.clientWidth > element.clientWidth
            ) {
              element.style.fontSize = text_size + "px";
              text_size++;
            }

            element.old_height = div.clientHeight;
            element.old_width = div.clientWidth;
          }
        } else {
          if (element.old_height == undefined) RESIZE = true;
          else if (element.old_height != div.clientHeight) RESIZE = true;

          if (RESIZE) {
            element.style.fontSize = text_size + "px";
            while (div.clientHeight > element.clientHeight) {
              element.style.fontSize = text_size + "px";
              text_size++;
            }

            element.old_height = div.clientHeight;
            element.old_width = div.clientWidth;
          }
        }
      }

      function startStopWatchClicked(e) {
        e.srcElement.style.display = "none";
        e.srcElement.parentElement.parentElement.children[2].children[1].style.display =
          "";
        e.srcElement.parentElement.parentElement.children[3].children[0].disabled = false;
        let lane_number = parseInt(
          e.srcElement.id.replace("lane", "").replace("_start_button", "")
        );
        let current_stopwatch_display =
          e.srcElement.parentElement.parentElement.children[1].innerText;
        if (current_stopwatch_display != "00:00.00") {
          let minutes = parseInt(current_stopwatch_display.substring(0, 2));
          let seconds = parseInt(current_stopwatch_display.substring(3, 5));
          let milis = parseInt(current_stopwatch_display.substring(6, 8));
          let adjustment = minutes * 60 * 1000 + seconds * 1000 + milis * 10;
          LANES[lane_number].stopwatch.start_time = Date.now() - adjustment;
        } else {
          LANES[lane_number].stopwatch.start_time = Date.now();
        }
        LANES[lane_number].stopwatch.running = true;
        e.srcElement.parentElement.parentElement.children[3].children[1].disabled = true;
      }

      function stopStopWatchClicked(e) {
        e.srcElement.style.display = "none";
        e.srcElement.parentElement.parentElement.children[2].children[0].style.display =
          "";
        e.srcElement.parentElement.parentElement.children[3].children[0].disabled = true;
        let lane_number = parseInt(
          e.srcElement.id.replace("lane", "").replace("_start_button", "")
        );
        LANES[lane_number].stopwatch.running = false;
        let time_elapsed = Date.now() - LANES[lane_number].stopwatch.start_time;
        let stopwatch = document.getElementById(
          "lane" + lane_number + "_stopwatch"
        );
        time_elapsed = new Date(time_elapsed);
        let milis = time_elapsed.getMilliseconds();
        milis = truncateToHundreth(milis);
        milis < 10 ? (milis = "0" + milis) : (milis = milis + "");
        let stopwatch_stop_time = `${checkTime(
          time_elapsed.getMinutes()
        )}:${checkTime(time_elapsed.getSeconds())}.${milis}`;

        e.srcElement.parentElement.parentElement.children[1].innerText =
          stopwatch_stop_time;
        e.srcElement.parentElement.parentElement.children[3].children[1].disabled = false;

        setTimeout(() => {
          const stopwatch_data = {
            action: "sendStopWatchInfo",
            roomKey: roomKey,
            lane_number: lane_number,
            time: stopwatch_stop_time,
            mills_to_display_stopwatch: MILLS_TO_DISPLAY_STOPWATCH,
          };
          socket.send(JSON.stringify(stopwatch_data));
        }, 1);
      }

      function clearStopWatchClicked(e) {
        e.srcElement.parentElement.parentElement.children[1].innerText =
          "00:00.00";
        e.srcElement.parentElement.parentElement.children[4].style.visibility =
          "hidden";
      }

      function splitStopWatchClicked(e) {
        e.srcElement.parentElement.parentElement.children[4].style.visibility =
          "";
        let lane_number = parseInt(
          e.srcElement.id
            .replace("lane", "")
            .replace("_stopwatch_split_button", "")
        );
        let time_elapsed = Date.now() - LANES[lane_number].stopwatch.start_time;
        time_elapsed = new Date(time_elapsed);
        let milis = time_elapsed.getMilliseconds();
        milis = truncateToHundreth(milis);
        milis < 10 ? (milis = "0" + milis) : (milis = milis + "");
        e.srcElement.parentElement.parentElement.children[4].innerText = `${checkTime(
          time_elapsed.getMinutes()
        )}:${checkTime(time_elapsed.getSeconds())}.${milis}`;
        e.srcElement.parentElement.parentElement.children[4].style.display = "";
      }

      function startAllStopwatchesClicked(e) {
        const stopwatch_display = document.getElementById("stopwatch_display");
        for (let i = 0; i < stopwatch_display.children.length; i++) {
          let panel = stopwatch_display.children[i];

          let lane_number = parseInt(
            panel.children[0].innerText.replace("Lane ", "")
          );
          if (!LANES[lane_number].stopwatch.running) {
            panel.children[2].children[0].click();
          }
        }
      }

      function clearAllStopwatchesClicked(e) {
        const stopwatch_display = document.getElementById("stopwatch_display");
        for (let i = 0; i < stopwatch_display.children.length; i++) {
          let panel = stopwatch_display.children[i];

          let lane_number = parseInt(
            panel.children[0].innerText.replace("Lane ", "")
          );
          if (!LANES[lane_number].stopwatch.running) {
            panel.children[3].children[1].click();
          }
        }
      }

      function stopAllStopwatchesClicked(e) {
        const stopwatch_display = document.getElementById("stopwatch_display");
        for (let i = 0; i < stopwatch_display.children.length; i++) {
          let panel = stopwatch_display.children[i];

          let lane_number = parseInt(
            panel.children[0].innerText.replace("Lane ", "")
          );
          if (LANES[lane_number].stopwatch.running) {
            panel.children[2].children[1].click();
          }
        }
      }

      function displaySplitTimeChanged(e) {
        let temp = e.target.value;
        temp = parseInt(temp) * 1000;
        MILLS_TO_DISPLAY_SPLITS = temp;
        localStorage.removeItem("mills_to_display_splits");
        localStorage.setItem(
          "mills_to_display_splits",
          MILLS_TO_DISPLAY_SPLITS
        );
      }

      function displayStopwatchTimeChanged(e) {
        let temp = e.target.value;
        temp = parseInt(temp) * 1000;
        MILLS_TO_DISPLAY_STOPWATCH = temp;
        localStorage.removeItem("mills_to_display_stopwatch");
        localStorage.setItem(
          "mills_to_display_stopwatch",
          MILLS_TO_DISPLAY_STOPWATCH
        );
      }

      function returnSplitTimeToDefault(e) {
        let split_display_setting = document.getElementById(
          "split_display_setting"
        );
        split_display_setting.value = MILLS_TO_DISPLAY_SPLITS_DEFAULT / 1000;
        displaySplitTimeChanged({
          target: { value: split_display_setting.value },
        });
      }

      function returnStopwatchTimeToDefault(e) {
        let stopwatch_display_setting = document.getElementById(
          "stopwatch_display_setting"
        );
        stopwatch_display_setting.value =
          MILLS_TO_DISPLAY_STOPWATCH_DEFAULT / 1000;
        displayStopwatchTimeChanged({
          target: { value: stopwatch_display_setting.value },
        });
      }

      function ignoreClick(e) {
        e.stopPropagation();
      }

      function clickAnywhere(e) {
        let options_div = document.getElementById("options_div");
        if (options_div.style.display == "") {
          options_div.style.display = "none";
          removeModal();
        }
        options_button_just_clicked = false;
      }

      function removeModal() {
        let modal = document.getElementById("modal");
        if (modal) modal.remove();
      }

      function dealWithCoachVideoList(data) {
        const video_display = document.getElementById("video_display");
        while (video_display.firstChild) video_display.firstChild.remove();
        const categories = Object.keys(data);
        categories.sort((a, b) => parseInt(a) - parseInt(b));

        categories.forEach((category) => {
          const category_div = document.createElement("div");
          category_div.id = category + "_category";
          category_div.classList.add("lane_display_container");
          video_display.appendChild(category_div);

          const category_label = document.createElement("p");
          category_label.innerText = category.toLocaleUpperCase();
          category_div.appendChild(category_label);

          const videos = Object.keys(data[category]);
          videos.sort((a, b) => parseInt(a) - parseInt(b));

          videos.forEach((video) => {
            const video_link = document.createElement("button");
            video_link.type = "button";
            video_link.innerText = data[category][video].title;
            video_link.video_title = data[category][video].title;
            video_link.video_id = data[category][video].id;
            video_link.classList.add("btn");
            video_link.classList.add("btn-primary");
            video_link.classList.add("nearly_full_width");
            video_link.addEventListener("click", videoLinkClicked);
            category_div.appendChild(video_link);
          });
        });
      }

      function videoLinkClicked(e) {
        const video_id = e.target.video_id;

        const lower_div = document.getElementById("lower_div");
        const video_display = document.getElementById("video_display");
        video_display.style.display = "none";

        const video_player_panel = document.createElement("div");
        video_player_panel.id = "video_player_panel";
        lower_div.appendChild(video_player_panel);

        const video_player_control_panel = document.createElement("div");
        video_player_control_panel.id = "video_player_control_panel";
        video_player_panel.appendChild(video_player_control_panel);

        const play_video_button = document.createElement("button");
        play_video_button.type = "button";
        play_video_button.innerText = "Play";
        play_video_button.classList.add("btn");
        play_video_button.classList.add("btn-success");
        play_video_button.addEventListener("click", playYoutubeVideoClicked);
        video_player_control_panel.appendChild(play_video_button);

        const pause_video_button = document.createElement("button");
        pause_video_button.type = "button";
        pause_video_button.innerText = "Pause";
        pause_video_button.classList.add("btn");
        pause_video_button.classList.add("btn-warning");
        pause_video_button.addEventListener("click", pauseYoutubeVideoClicked);
        video_player_control_panel.appendChild(pause_video_button);

        const stop_video_button = document.createElement("button");
        stop_video_button.type = "button";
        stop_video_button.innerText = "Stop";
        stop_video_button.classList.add("btn");
        stop_video_button.classList.add("btn-danger");
        stop_video_button.addEventListener("click", stopYoutubeVideoClicked);
        video_player_control_panel.appendChild(stop_video_button);

        const restart_video_button = document.createElement("button");
        restart_video_button.type = "button";
        restart_video_button.innerText = "Restart";
        restart_video_button.classList.add("btn");
        restart_video_button.classList.add("btn-success");
        restart_video_button.addEventListener(
          "click",
          restartYoutubeVideoClicked
        );
        video_player_control_panel.appendChild(restart_video_button);

        const return_to_video_list_button = document.createElement("button");
        return_to_video_list_button.type = "button";
        return_to_video_list_button.innerText = "Return to Video List";
        return_to_video_list_button.classList.add("btn");
        return_to_video_list_button.classList.add("btn-primary");
        return_to_video_list_button.addEventListener(
          "click",
          returnToVideoListClicked
        );
        video_player_control_panel.appendChild(return_to_video_list_button);

        const wrapper = document.createElement("div");
        wrapper.id = "wrapper";
        video_player_panel.appendChild(wrapper);

        const video_player = document.createElement("div");
        video_player.id = "video_player";
        wrapper.appendChild(video_player);

        let video_action_data = {
          action: "sendVideoEvent",
          event: "load",
          roomKey: roomKey,
          video_id: video_id,
        };
        socket.send(JSON.stringify(video_action_data));

        player = new YT.Player("video_player", {
          height: "390",
          width: "640",
          videoId: video_id,
          playlist: video_id,
          loop: 1,
          playerVars: {
            playsinline: 0,
            controls: 0,
            disablekb: 1,
            enablejsapi: 1,
            fs: 0,
            iv_load_policy: 3,
            loop: 1,
            origin: window.location.hostname,
            rel: 0,
          },
          events: {
            onReady: onPlayerReady,
            onStateChange: onPlayerStateChange,
          },
        });

        const player_blocker = document.createElement("div");
        player_blocker.id = "player_blocker";
        wrapper.appendChild(player_blocker);
      }

      function onYouTubeIframeAPIReady() {}

      function onPlayerStateChange(e) {
        if (e.data == YT.PlayerState.ENDED) player.playVideo();
      }

      function onPlayerReady() {
        player.mute();
      }

      function playYoutubeVideoClicked(e) {
        let video_action_data = {
          action: "sendVideoEvent",
          roomKey: roomKey,
          event: "play",
        };
        socket.send(JSON.stringify(video_action_data));
        player.playVideo();
      }

      function pauseYoutubeVideoClicked(e) {
        let video_action_data = {
          action: "sendVideoEvent",
          roomKey: roomKey,
          event: "pause",
        };
        socket.send(JSON.stringify(video_action_data));
        player.pauseVideo();
      }

      function restartYoutubeVideoClicked(e) {
        let video_action_data = {
          action: "sendVideoEvent",
          roomKey: roomKey,
          event: "restart",
        };
        socket.send(JSON.stringify(video_action_data));
        player.stopVideo();
        player.playVideo();
      }

      function stopYoutubeVideoClicked(e) {
        let video_action_data = {
          action: "sendVideoEvent",
          roomKey: roomKey,
          event: "stop",
        };
        socket.send(JSON.stringify(video_action_data));
        player.stopVideo();
      }

      function returnToVideoListClicked(e) {
        player.stopVideo();
        let video_action_data = {
          action: "sendVideoEvent",
          roomKey: roomKey,
          event: "exit_video_mode",
        };
        socket.send(JSON.stringify(video_action_data));
        const video_player_panel =
          document.getElementById("video_player_panel");
        video_player_panel.remove();

        const video_display = document.getElementById("video_display");
        video_display.style.display = "";
      }

      function removeVideoPlayerPanel() {
        let video_action_data = {
          action: "sendVideoEvent",
          roomKey: roomKey,
          event: "exit_video_mode",
        };
        socket.send(JSON.stringify(video_action_data));
        const video_player_panel =
          document.getElementById("video_player_panel");
        if (video_player_panel) video_player_panel.remove();
      }

      function pickSetClicked() {
        const body_collection = document.getElementsByTagName("body");
        const body = body_collection[0];

        const pick_set_display = document.createElement("div");
        pick_set_display.id = "pick_set_display";
        body.appendChild(pick_set_display);

        const practices_display = document.createElement("div");
        practices_display.id = "practices_display";
        pick_set_display.appendChild(practices_display);

        const practices_div = document.createElement("div");
        practices_div.id = "practices_div";
        practices_display.appendChild(practices_div);

        const individual_practice = document.createElement("div");
        individual_practice.id = "individual_practice";
        practices_display.appendChild(individual_practice);

        loadPractices();
      }

      async function loadPractices() {
        let practices_div = document.getElementById("practices_div");
        setPracticesAsLoading(practices_div);

        const headers = {
          "Content-Type": "application/json",
        };

        const requestOptions = {
          method: "GET",
          headers: headers,
        };

        let result = await fetch(
          "https://c6a7fgweplcxu3yjgx5gkklxce0nopqg.lambda-url.us-east-2.on.aws/?coach_id=" +
            COACH_ID,
          requestOptions
        );

        let practice_info = await result.json();

        let practices = practice_info.practices;
        let metadata = practice_info.metadata;

        practices.sort((a, b) => {
          let a_date = new Date(a.year, a.month - 1, a.day).getTime();
          let b_date = new Date(b.year, b.month - 1, b.day).getTime();
          if (b_date - a_date == 0)
            return b.practice_of_the_day - a.practice_of_the_day;
          return b_date - a_date;
        });

        while (practices_div.children.length != 0)
          practices_div.children[0].remove();

        practices.forEach((practice) => {
          if (practice.group == "") practice.group = "-undefined-";
          const practice_div = document.createElement("div");
          practice_div.classList.add("practice_small_display");
          practice_div.innerText = `${practice.month}/${practice.day}/${practice.year} - Group: ${practice.group}  - #${practice.practice_of_the_day}`;
          practice_div.practice_info = practice;
          practice_div.addEventListener("click", practiceClicked);
          practices_div.appendChild(practice_div);
        });
      }

      function setPracticesAsLoading(practices_div) {
        while (practices_div.children.length != 0)
          practices_div.children[0].remove();

        const practice_div = document.createElement("div");
        practice_div.classList.add("practice_small_display_loading");
        practice_div.innerText = "Loading saved practices...";
        practices_div.appendChild(practice_div);
      }

      async function practiceClicked(e) {
        const individual_practice = document.getElementById(
          "individual_practice"
        );
        while (individual_practice.children.length != 0)
          individual_practice.children[0].remove();
        const loading_message = document.createElement("div");
        loading_message.innerText = "Loading practice...";
        individual_practice.appendChild(loading_message);

        let filename = this.practice_info.filename;
        filename = encodeURIComponent(filename);

        const headers = {
          "Content-Type": "application/json",
        };

        let url =
          "https://lufypj7qre3hbvkvasijiv7rhy0tvrtr.lambda-url.us-east-2.on.aws/?filename=" +
          filename;

        const requestOptions = {
          method: "GET",
          redirect: "follow",
        };

        fetch(url, requestOptions)
          .then((response) => response.text())
          .then((practice) => {
            practice = JSON.parse(practice);

            while (individual_practice.children.length != 0)
              individual_practice.children[0].remove();

            const bottom_part = document.createElement("div");
            bottom_part.classList.add("individual_practice_bottom_part");
            individual_practice.appendChild(bottom_part);

            displayPractice(bottom_part, practice);
            let sides = document.getElementsByClassName("side");
            for (let count = 0; count < sides.length; count++)
              displayPractice(sides[count], practice);
            individual_practice.filename = filename;
          })
          .catch((error) => {
            working_modal.style.display = "none";
            console.error(error);
          });
      }

      function displayPractice(element_to_display_to, practice) {
        let keys = Object.keys(practice.practice);
        keys.sort((a, b) => parseInt(a) - parseInt(b));
        for (let i = 0; i < keys.length; i++) {
          const set_display = document.createElement("div");
          set_display.classList.add("individual_set");
          element_to_display_to.appendChild(set_display);
          displaySet(set_display, practice.practice[keys[i]]);
        }
      }

      function displaySet(element_to_display_to, set, force_display_set_rep) {
        if (force_display_set_rep == undefined) force_display_set_rep = false;
        if (!force_display_set_rep) {
          element_to_display_to.addEventListener("touchstart", onFingerPress);
          element_to_display_to.addEventListener("mousedown", onFingerPress);
          element_to_display_to.addEventListener("touchend", onFingerRise);
          element_to_display_to.addEventListener("mouseup", onFingerRise);
          element_to_display_to.set = set;
        }
        if (set.repeats > 1 || force_display_set_rep) {
          const left_side = document.createElement("div");
          left_side.classList.add("set_repeat_side");
          element_to_display_to.appendChild(left_side);

          const curly_brace_wrapper = document.createElement("div");
          curly_brace_wrapper.classList.add("curly_brace_wrapper");
          element_to_display_to.appendChild(curly_brace_wrapper);

          const curly_brace_part_one = document.createElement("div");
          curly_brace_part_one.classList.add("curly_brace_part_one");
          curly_brace_part_one.classList.add("brace");
          curly_brace_wrapper.appendChild(curly_brace_part_one);

          const curly_brace_part_two = document.createElement("div");
          curly_brace_part_two.classList.add("curly_brace_part_two");
          curly_brace_part_two.classList.add("brace");
          curly_brace_wrapper.appendChild(curly_brace_part_two);

          const curly_brace_part_three = document.createElement("div");
          curly_brace_part_three.classList.add("curly_brace_part_three");
          curly_brace_part_three.classList.add("brace");
          curly_brace_wrapper.appendChild(curly_brace_part_three);

          const curly_brace_part_four = document.createElement("div");
          curly_brace_part_four.classList.add("curly_brace_part_four");
          curly_brace_part_four.classList.add("brace");
          curly_brace_wrapper.appendChild(curly_brace_part_four);

          const set_repeat = document.createElement("div");
          set_repeat.innerText = set.repeats + " X";
          left_side.appendChild(set_repeat);
        }

        const right_side = document.createElement("div");
        right_side.classList.add("set_display_side");
        element_to_display_to.appendChild(right_side);

        if (set.description && set.description != "") {
          const set_description = document.createElement("div");
          set_description.innerText = set.description;
          right_side.appendChild(set_description);
        }

        let keys = Object.keys(set);
        let temp = [];
        for (let i = 0; i < keys.length; i++)
          if (keys[i] != "repeats") temp.push(keys[i]);
        keys = temp;
        for (let i = 0; i < keys.length; i++) {
          let key = keys[i];
          let element = set[key];

          if (set[key].type == "standard") {
            let sendoffs = Object.keys(element.sendoffs);
            sendoffs.sort((a, b) => b - a);
            let A_reps = element.sendoffs[sendoffs[0]].reps;
            let all_the_same_reps = true;

            for (let k = 1; k < sendoffs.length; k++)
              if (element.sendoffs[sendoffs[k]].reps != A_reps)
                all_the_same_reps = false;

            let description_split = element.description.split("\n");

            let standard_element_div = document.createElement("div");
            right_side.appendChild(standard_element_div);

            let standard_element_div_top_part = document.createElement("div");
            if (description_split.length == 1) {
            }

            if (A_reps > 1)
              standard_element_div_top_part.innerText =
                A_reps +
                " X " +
                element.distance +
                " " +
                description_split[0] +
                " @";
            else {
              if (element.distance > 0)
                standard_element_div_top_part.innerText =
                  element.distance + " " + description_split[0] + " @";
              else
                standard_element_div_top_part.innerText =
                  description_split[0] + " @";
            }

            standard_element_div_top_part.innerText +=
              " " + timeToString(element.sendoffs[sendoffs[0]].time);
            if (sendoffs.length != 1) {
              for (let k = 1; k < sendoffs.length; k++) {
                standard_element_div_top_part.innerText += " / ";
                if (!all_the_same_reps) {
                  if (A_reps != element.sendoffs[sendoffs[k]].reps) {
                    standard_element_div_top_part.innerText +=
                      "(" + element.sendoffs[sendoffs[k]].reps + "x) ";
                  }
                }
                standard_element_div_top_part.innerText += timeToString(
                  element.sendoffs[sendoffs[k]].time
                );
              }
            }

            standard_element_div.appendChild(standard_element_div_top_part);

            if (description_split.length > 1) {
              let standard_element_div_bottom_part =
                document.createElement("div");
              for (let part = 1; part < description_split.length; part++) {
                let part_working_on = description_split[part];
                part_working_on.trim();
                if (!part_working_on.startsWith("-"))
                  part_working_on = "- " + part_working_on;
                if (part == 1) {
                  standard_element_div_bottom_part.innerHTML = part_working_on;
                } else {
                  standard_element_div_bottom_part.innerHTML +=
                    "<br />" + part_working_on;
                }
              }

              standard_element_div_bottom_part.style.paddingLeft = "5%";
              standard_element_div.appendChild(
                standard_element_div_bottom_part
              );
            }
          } else if (element.type == "multi-part") {
            const element_display = document.createElement("div");
            right_side.appendChild(element_display);

            const element_display_top_part = document.createElement("div");
            element_display_top_part.innerText =
              element.max_reps + " X " + element.distance;
            element_display.appendChild(element_display_top_part);

            const element_display_bottom_part = document.createElement("div");
            element_display.appendChild(element_display_bottom_part);

            let sendoff_letters = Object.keys(element.sendoffs);
            sendoff_letters.sort((a, b) => a - b);
            let a_reps = Object.keys(element.sendoffs[sendoff_letters[0]]);
            keys.sort((a, b) => parseInt(a) - parseInt(a));
            for (let k = 0; k < a_reps.length; k++) {
              const rep_part_div = document.createElement("div");
              rep_part_div.innerText =
                element.sendoffs[sendoff_letters[0]][a_reps[k]].rep +
                " " +
                element.sendoffs[sendoff_letters[0]][a_reps[k]].description +
                " @ " +
                timeToString(
                  element.sendoffs[sendoff_letters[0]][a_reps[k]].value
                );
              rep_part_div.classList.add("rep_part");
              rep_part_div.first_rep =
                element.sendoffs[sendoff_letters[0]][a_reps[k]].rep;
              rep_part_div.first_sendoff =
                element.sendoffs[sendoff_letters[0]][a_reps[k]].value;
              element_display_bottom_part.appendChild(rep_part_div);
            }

            let display_all_reps = false,
              display_all_times = false;

            for (let k = 1; k < sendoff_letters.length; k++) {
              let sendoff_letter = sendoff_letters[k];
              let sendoff_working_on = element.sendoffs[sendoff_letter];
              for (let l = 0; l < sendoff_working_on.length; l++) {
                let description_part = sendoff_working_on[l];
                let corresponding_A_div =
                  element_display_bottom_part.children[l];
                if (
                  corresponding_A_div.first_rep != description_part.rep &&
                  corresponding_A_div.first_rep + ":" != description_part.rep &&
                  corresponding_A_div.first_rep != description_part.rep + ":"
                )
                  display_all_reps = true;
                else if (
                  corresponding_A_div.first_sendoff != description_part.value
                )
                  display_all_times = true;
              }
            }

            for (let k = 1; k < sendoff_letters.length; k++) {
              let sendoff_letter = sendoff_letters[k];
              let sendoff_working_on = element.sendoffs[sendoff_letter];
              for (let l = 0; l < sendoff_working_on.length; l++) {
                let description_part = sendoff_working_on[l];
                let corresponding_A_div =
                  element_display_bottom_part.children[l];
                let stop = 0;

                if (display_all_reps) {
                  corresponding_A_div.innerText +=
                    " / " +
                    description_part.rep +
                    " @ " +
                    timeToString(description_part.value);
                } else if (display_all_times) {
                  corresponding_A_div.innerText +=
                    " / " + timeToString(description_part.value);
                }
              }
            }
          } else if (element.type == "subset") {
            let sub_set_display = document.createElement("div");
            sub_set_display.classList.add("individual_set");
            right_side.appendChild(sub_set_display);
            displaySet(sub_set_display, element.set, true);
          }
        }
      }

      function timeToString(time) {
        let min = Math.trunc(time / 60);
        let sec = time - 60 * min;
        if (sec < 10) sec = "0" + sec;
        if (min > 0) return min + ":" + sec;
        return ":" + sec;
      }

      function onFingerPress(e) {
        this.style.boxShadow =
          "rgba(50, 50, 93, 0.25) 0px 30px 60px -12px inset, rgba(0, 0, 0, 0.3) 0px 18px 36px -18px inset";
      }

      function onFingerRise(e) {
        let start = performance.now();
        this.style.boxShadow = "";
        loadSet(this.set);
        let time = performance.now() - start;
      }

      function loadSet(set) {
        let sendoff_lists = _getSendoffLists(set);

        let body = document.getElementsByTagName("body");
        body = body[0];
        const assign_lanes_popup = document.createElement("div");
        assign_lanes_popup.id = "assign_lanes_popup";
        body.appendChild(assign_lanes_popup);

        const assign_lanes_inner = document.createElement("div");
        assign_lanes_inner.id = "assign_lanes_inner";
        assign_lanes_popup.appendChild(assign_lanes_inner);
        assign_lanes_popup.sendoff_lists = sendoff_lists;

        const sendoffs = Object.keys(sendoff_lists);
        sendoffs.sort((a, b) => a - b);

        const lanes_list = Object.keys(LANES);

        for (let i = 0; i < lanes_list.length; i++) {
          const sendoff_match_wrapper = document.createElement("div");
          sendoff_match_wrapper.classList.add("sendoff_match_wrapper");
          assign_lanes_inner.appendChild(sendoff_match_wrapper);

          const sendoff_match_label = document.createElement("div");
          sendoff_match_label.innerText = "Lane " + lanes_list[i] + ":";
          sendoff_match_wrapper.appendChild(sendoff_match_label);

          const sendoff_match_select = document.createElement("select");
          sendoff_match_select.multiple = false;
          sendoff_match_wrapper.appendChild(sendoff_match_select);
          for (let j = 0; j < sendoffs.length; j++) {
            const option = document.createElement("option");
            option.innerText = sendoffs[j];
            sendoff_match_select.add(option);
          }

          const swimmer_count_label = document.createElement("div");
          swimmer_count_label.innerText = "Swimmer Count:";
          sendoff_match_wrapper.appendChild(swimmer_count_label);

          const swimmer_count_select = document.createElement("select");
          swimmer_count_select.multiple = false;
          sendoff_match_wrapper.appendChild(swimmer_count_select);

          for (let j = 1; j <= 30; j++) {
            const option = document.createElement("option");
            option.innerText = j;
            if (j == 4) option.selected = true;
            swimmer_count_select.add(option);
          }

          const seconds_apart_label = document.createElement("div");
          seconds_apart_label.innerText = "Seconds apart:";
          sendoff_match_wrapper.appendChild(seconds_apart_label);

          const seconds_apart_select = document.createElement("select");
          seconds_apart_select.multiple = false;
          sendoff_match_wrapper.appendChild(seconds_apart_select);

          for (let j = 1; j < 30; j++) {
            const option = document.createElement("option");
            option.innerText = j;
            if (j == 5) option.selected = true;
            seconds_apart_select.add(option);
          }
        }

        const assign_lanes_button = document.createElement("button");
        assign_lanes_button.innerText = "Assign Lanes";
        assign_lanes_button.id = "assign_lanes_button";
        assign_lanes_button.classList.add("btn");
        assign_lanes_button.classList.add("btn-success");
        assign_lanes_button.addEventListener("click", assignLanesClicked);
        assign_lanes_inner.appendChild(assign_lanes_button);
      }

      function _getSendoffs(set) {
        if (set == null) return null;
        let sendoffs = [];

        let numbers = Object.keys(set);
        let temp = [];
        for (let i = 0; i < numbers.length; i++)
          if (numbers[i] != "repeats") temp.push(numbers[i]);
        numbers = temp;
        for (let i = 0; i < numbers.length; i++) {
          let element = set[numbers[i]];
          if (element.type == "standard" || element.type == "multi-part") {
            let letters = Object.keys(element.sendoffs);
            for (let j = 0; j < letters.length; j++) {
              let letter = letters[j];
              if (!sendoffs.includes(letter)) {
                sendoffs.push(letter);
              }
            }
          } else if (element.type == "subset") {
            let sub_set_letters = _getSendoffs(element.set);
            for (let j = 0; j < sub_set_letters.length; j++)
              if (!sendoffs.includes(sub_set_letters[j]))
                sendoffs.push(sub_set_letters[j]);
          }
        }

        return sendoffs;
      }

      function _getSendoffLists(set) {
        let by_round_elements = [];
        if (set == null) return null;
        let all_sendoffs = _getSendoffs(set);
        all_sendoffs.sort((a, b) => parseInt(a) - parseInt(b));
        let more_than_one_sendoff = false;
        if (all_sendoffs.length > 1) more_than_one_sendoff = true;

        if (all_sendoffs.length == 0) return null;

        let element_keys = Object.keys(set);
        let temp = [];
        for (let i = 0; i < element_keys.length; i++)
          if (element_keys[i] != "repeats") temp.push(element_keys[i]);
        element_keys = temp;
        element_keys.sort((a, b) => parseInt(a) - parseInt(b));
        let first_sendoff = all_sendoffs[0];
        let sendoff_lists = {};
        for (let i = 0; i < all_sendoffs.length; i++) {
          sendoff_lists[all_sendoffs[i]] = {};
          sendoff_lists[all_sendoffs[i]].start_time = 0;
          sendoff_lists[all_sendoffs[i]].running_time = 0;
          sendoff_lists[all_sendoffs[i]].list = [];
        }
        for (let i = 0; i < set.repeats; i++) {
          for (let l = 0; l < element_keys.length; l++) {
            let sendoffs_done_list = [];
            let element = set[element_keys[l]];

            //standard element processing
            if (element.type == "standard") {
              let list = [];

              for (let j = 0; j < all_sendoffs.length; j++) {
                let sendoff_this_is = all_sendoffs[j];
                sendoffs_done_list.push(sendoff_this_is);
                let letter_to_get_sendoffs_for = all_sendoffs[j];
                let element_sendoffs = Object.keys(element.sendoffs);
                if (
                  element_sendoffs.length != all_sendoffs.length &&
                  element_sendoffs.length != 1
                )
                  throw new Error("Sendoff Mismatch");
                if (!element_sendoffs.includes(letter_to_get_sendoffs_for))
                  letter_to_get_sendoffs_for = all_sendoffs[0];

                for (
                  let k = 0;
                  k < element.sendoffs[letter_to_get_sendoffs_for].reps;
                  k++
                ) {
                  let item = {
                    time: sendoff_lists[sendoff_this_is].running_time,
                    rep_time: element.sendoffs[letter_to_get_sendoffs_for].time,
                    distance: element.distance,
                    description: element.description,
                    rep_number: k + 1,
                  };
                  sendoff_lists[sendoff_this_is].running_time += item.rep_time;
                  sendoff_lists[sendoff_this_is].list.push(item);
                }
              }
            }

            //multi-part element processing
            else if (element.type == "multi-part") {
              for (let j = 0; j < all_sendoffs.length; j++) {
                let sendoff_this_is = all_sendoffs[j];
                let letter_to_get_sendoffs_for = all_sendoffs[j];
                let element_sendoffs = Object.keys(element.sendoffs);
                let temp = [];
                for (let t = 0; t < element_sendoffs.length; t++)
                  if (/^[a-zA-Z]$/.test(element_sendoffs[t]))
                    temp.push(element_sendoffs[t]);
                element_sendoffs = temp;
                element_sendoffs.sort((a, b) => parseInt(a) - parseInt(b));

                if (
                  element_sendoffs.length != all_sendoffs.length &&
                  element_sendoffs.length != 1
                )
                  throw new Error("Sendoff Mismatch");
                let first_set_description_count =
                  element.sendoffs[element_sendoffs[0]].length;
                for (let p = 1; p < element_sendoffs.length; p++) {
                  if (
                    first_set_description_count !=
                      element.sendoffs[element_sendoffs[p]].length &&
                    element.sendoffs[element_sendoffs[p]].length != 1
                  )
                    throw new Error("Sendoff Mismatch");
                }
                if (!element_sendoffs.includes(letter_to_get_sendoffs_for))
                  letter_to_get_sendoffs_for = all_sendoffs[0];

                let parts_key = Object.keys(
                  element.sendoffs[letter_to_get_sendoffs_for]
                );
                parts_key.sort((a, b) => parseInt(a) - parseInt(b));
                let temp_list = [];
                let running_time = sendoff_lists[sendoff_this_is].running_time;

                if (
                  element.multi_description_type ==
                  MULTI_DESCRIPTION_TYPE.SPLIT_EVENLY
                ) {
                  for (k = 0; k < parts_key.length; k++) {
                    let part =
                      element.sendoffs[letter_to_get_sendoffs_for][
                        parts_key[k]
                      ];
                    let numbers = _splitDescriptionIntoNumbers(part);
                    let ind_numbers = Object.keys(numbers);
                    ind_numbers.sort((a, b) => parseInt(a) - parseInt(b));
                    for (let num = 0; num < ind_numbers.length; num++) {
                      let num_to_get = ind_numbers[num];
                      let item = {
                        time: running_time,
                        rep_time: numbers[num_to_get].value,
                        distance: element.distance,
                        description: numbers[num_to_get].description,
                        rep_number: parseInt(num_to_get),
                      };
                      running_time += item.rep_time;
                      temp_list.push(item);
                    }
                    temp_list.sort((item1, item2) => {
                      return item1.rep_number - item2.rep_number;
                    });
                    let last_number = temp_list[0].rep_number;

                    for (let q = 1; q < temp_list.length; q++) {
                      if (last_number >= temp_list[q].rep_number)
                        throw new Error("Sendoff Mismatch");
                      else last_number = temp_list[q].rep_number;
                    }
                  }
                  sendoff_lists[sendoff_this_is].list.push(...temp_list);
                  sendoff_lists[sendoff_this_is].running_time = running_time;
                } else if (
                  element.multi_description_type ==
                  MULTI_DESCRIPTION_TYPE.REPEAT_ONE_AT_A_TIME
                ) {
                  let running_time =
                    sendoff_lists[sendoff_this_is].running_time;
                  for (k = 0; k < parts_key.length; k++) {
                    let part =
                      element.sendoffs[letter_to_get_sendoffs_for][
                        parts_key[k]
                      ];
                    let numbers = _splitDescriptionIntoNumbers(part);
                    let ind_numbers = Object.keys(numbers);
                    ind_numbers.sort((a, b) => parseInt(a) - parseInt(b));
                    for (let num = 0; num < ind_numbers.length; num++) {
                      let num_to_get = ind_numbers[num];
                      let item = {
                        time: sendoff_lists[sendoff_this_is].running_time,
                        rep_time: numbers[num_to_get].value,
                        distance: element.distance,
                        description: numbers[num_to_get].description,
                        rep_number: parseInt(num_to_get),
                      };
                      running_time += item.rep_time;
                      temp_list.push(item);
                    }
                  }
                  temp_list.sort((item1, item2) => {
                    return item1.rep_number - item2.rep_number;
                  });

                  let last_number = temp_list[0].rep_number;
                  for (let q = 1; q < temp_list.length; q++) {
                    if (last_number >= temp_list[q].rep_number)
                      throw new Error("Sendoff Mismatch");
                    else last_number = temp_list[q].rep_number;
                  }

                  let rep = temp_list[0].rep_number;
                  if (sendoff_lists[sendoff_this_is].list.length != 0) {
                    running_time =
                      sendoff_lists[sendoff_this_is].list[
                        sendoff_lists[sendoff_this_is].list.length - 1
                      ].time +
                      sendoff_lists[sendoff_this_is].list[
                        sendoff_lists[sendoff_this_is].list.length - 1
                      ].rep_time;
                  }
                  running_time = sendoff_lists[sendoff_this_is].running_time;
                  while (rep <= element.max_reps) {
                    for (
                      let w = 0;
                      w < temp_list.length && rep <= element.max_reps;
                      w++
                    ) {
                      let copy = {
                        time: running_time,
                        rep_time: temp_list[w].rep_time,
                        distance: temp_list[w].distance,
                        description: temp_list[w].description,
                        rep_number: rep,
                      };
                      running_time += copy.rep_time;
                      sendoff_lists[sendoff_this_is].list.push(copy);

                      rep++;
                    }
                  }

                  sendoff_lists[sendoff_this_is].running_time =
                    sendoff_lists[sendoff_this_is].list[
                      sendoff_lists[sendoff_this_is].list.length - 1
                    ].time +
                    sendoff_lists[sendoff_this_is].list[
                      sendoff_lists[sendoff_this_is].list.length - 1
                    ].rep_time;
                } else if (
                  element.multi_description_type ==
                  MULTI_DESCRIPTION_TYPE.BY_ROUND
                ) {
                  element.id = createElelementID();
                  by_round_elements.push(element);

                  sendoff_lists[sendoff_this_is].list.push(element);
                }
              }
            } else if (element.type == "subset") {
              let subsendoffs = _getSendoffLists(element.set);
              //have the subsendoffs, copy them to the main sendoff list

              if (all_sendoffs.length != Object.keys(subsendoffs).length)
                return null;

              for (
                let sendoff_index = 0;
                sendoff_index < all_sendoffs.length;
                sendoff_index++
              ) {
                let copying_letter = all_sendoffs[sendoff_index];
                let temp_list = [];
                let running_time = -1;
                if (sendoff_lists[copying_letter].running_time)
                  running_time = sendoff_lists[copying_letter].running_time;
                else running_time = 0;
                for (
                  let index = 0;
                  index < subsendoffs[copying_letter].list.length;
                  index++
                ) {
                  subsendoffs[copying_letter].list[index].time = running_time;
                  sendoff_lists[copying_letter].list.push(
                    subsendoffs[copying_letter].list[index]
                  );
                  running_time +=
                    subsendoffs[copying_letter].list[index].rep_time;
                  sendoff_lists[copying_letter].running_time = running_time;
                }
              }
            }
          }
        }

        //replace by round elemeents
        let need_to_redo_final_sendoff = false;

        //go through each letter that we have sendoffs for
        for (
          let sendoff_index = 0;
          sendoff_index < all_sendoffs.length;
          sendoff_index++
        ) {
          let letter_working_on = all_sendoffs[sendoff_index];

          let element_ids = [];
          //get id's for each by round element
          for (
            let i = 0;
            i < sendoff_lists[letter_working_on].list.length;
            i++
          ) {
            if (
              sendoff_lists[letter_working_on].list[i].multi_description_type ==
              MULTI_DESCRIPTION_TYPE.BY_ROUND
            ) {
              if (
                !element_ids.includes(
                  sendoff_lists[letter_working_on].list[i].id
                )
              ) {
                element_ids.push(sendoff_lists[letter_working_on].list[i].id);
              }
            }
          }

          //now we have by round elements, go through by each element id and replace the element with lists
          for (
            let element_index = 0;
            element_index < element_ids.length;
            element_index++
          ) {
            need_to_redo_final_sendoff = true;
            let round_working_on = 1;
            let element_id = element_ids[element_index];

            //start copying each sendoff to a temp list until we get to an id that matches

            let final_list_for_letter = [];
            let temp_list = [];
            let running_time = 0;
            for (
              let i = 0;
              i < sendoff_lists[letter_working_on].list.length;
              i++
            ) {
              if (sendoff_lists[letter_working_on].list[i].id != element_id) {
                temp_list.push(sendoff_lists[letter_working_on].list[i]);
              } else {
                //we have found an element that we are replacing sendoffs for
                if (i > 0) {
                  running_time =
                    sendoff_lists[letter_working_on].list[i - 1].time +
                    sendoff_lists[letter_working_on].list[i - 1].rep_time;
                }

                let letter_to_get_sendoffs_from = letter_working_on;
                if (
                  !sendoff_lists[letter_working_on].list[i].sendoffs[
                    letter_working_on
                  ]
                )
                  letter_to_get_sendoffs_from = "A";

                let part = sendoff_lists[letter_working_on].list[i];
                let index_of_rep = -1;

                for (
                  let k = 0;
                  k < part.sendoffs[letter_to_get_sendoffs_from].length;
                  k++
                ) {
                  let checking = part.sendoffs[letter_to_get_sendoffs_from][
                    k
                  ].rep
                    .toUpperCase()
                    .replace("RD", "");
                  checking = checking.replace(":", "").trim();
                  checking = parseInt(checking);
                  if (round_working_on == checking) {
                    index_of_rep = k;
                    break;
                  }
                }

                if (index_of_rep != -1) {
                  let added_to_temp = false;
                  //we now have the index of the rep we are doing, copy it to the temp list
                  for (let k = 0; k < part.max_reps; k++) {
                    let item = {
                      time: running_time,
                      rep_time:
                        part.sendoffs[letter_to_get_sendoffs_from][index_of_rep]
                          .value,
                      distance: part.distance,
                      description:
                        part.sendoffs[letter_to_get_sendoffs_from][index_of_rep]
                          .description,
                      rep_number: k + 1,
                    };

                    running_time = running_time + item.rep_time;

                    temp_list.push(item);
                    added_to_temp = true;
                  }

                  //we changed a round one to a sendoff list, copy the remaining and start over at the top
                  if (added_to_temp) {
                    for (
                      j = i + 1;
                      j < sendoff_lists[letter_working_on].list.length;
                      j++
                    ) {
                      let old_item = sendoff_lists[letter_working_on].list[j];
                      if (old_item.type != "multi-part") {
                        let new_item = {
                          time: running_time,
                          rep_time: old_item.rep_time,
                          distance: old_item.distance,
                          description: old_item.description,
                          rep_number: old_item.rep_number,
                        };
                        running_time = running_time + old_item.rep_time;
                        temp_list.push(new_item);
                      } else {
                        temp_list.push(old_item);
                      }
                    }
                    sendoff_lists[letter_working_on].list = temp_list;
                    temp_list = [];
                    i = -1;
                    round_working_on++;
                  }
                }
              }
            }
          }
        }

        //remove any unassigned by round parts
        for (let i = 0; i < all_sendoffs.length; i++) {
          let temp_list = [];
          for (let k = 0; k < sendoff_lists[all_sendoffs[i]].list.length; k++) {
            if (!sendoff_lists[all_sendoffs[i]].list[k].type) {
              temp_list.push(sendoff_lists[all_sendoffs[i]].list[k]);
            }
          }
          sendoff_lists[all_sendoffs[i]].list = temp_list;
        }

        if (need_to_redo_final_sendoff) {
          for (let i = 0; i < all_sendoffs.length; i++) {
            sendoff_lists[all_sendoffs[i]].running_time =
              sendoff_lists[all_sendoffs[i]].list[
                sendoff_lists[all_sendoffs[i]].list.length - 1
              ].time +
              sendoff_lists[all_sendoffs[i]].list[
                sendoff_lists[all_sendoffs[i]].list.length - 1
              ].rep_time;
          }
        }

        return sendoff_lists;
      }

      function _splitDescriptionIntoNumbers(description, type) {
        if (!type) type = 2;
        let temp = _isValidDescriptionNumbers(description.rep, type, 1000000);
        if (!temp) return undefined;

        let rep_text = description.rep;
        rep_text = rep_text.replace(/\s/g, "");
        if (rep_text.endsWith(":"))
          rep_text = rep_text.substring(0, rep_text.length - 1);

        let split_by_comma = rep_text.split(",");
        let parts = {};
        for (let i = 0; i < split_by_comma.length; i++) {
          let part = split_by_comma[i];

          if (!part.includes("-")) {
            let sub_description = {};
            sub_description.description = description.description;
            sub_description.value = description.value;

            parts[part] = sub_description;
          } else {
            let split_by_hypen = split_by_comma[i].split("-");
            let min = parseInt(split_by_hypen[0]);
            let max = parseInt(split_by_hypen[1]);
            for (let j = min; j <= max; j++) {
              let sub_description = {};
              sub_description.description = description.description;
              sub_description.value = description.value;

              parts[j] = sub_description;
            }
          }
        }

        return parts;
      }

      function createElelementID() {
        let letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
        letters += letters.toLowerCase();
        letters += "1234567890";
        letters += "-_";

        let id = "";

        while (id.length < 80) {
          id += letters.charAt(Math.floor(Math.random() * letters.length));
        }

        return id;
      }

      function _isValidDescriptionNumbers(value, type, max_reps) {
        value = value.replace(/\s/g, "");
        value = value.replace(/:/g, "");
        if (type == MULTI_DESCRIPTION_TYPE.BY_ROUND) {
          value = value.toUpperCase();
          value = value.replace("RD", "");
        }
        if (!containsOnlyAcceptableChars(value)) return false;
        let comma_split = value.split(",");
        let numbers = [];
        for (let i = 0; i < comma_split.length; i++) {
          let split_part = comma_split[i];
          if (split_part.includes("-")) {
            let split_dash = split_part.split("-");
            if (split_dash.length != 2) {
              return false;
            }
            let first_number = parseInt(split_dash[0]);
            let second_number = parseInt(split_dash[1]);
            if (isNaN(first_number) || isNaN(second_number)) {
              return false;
            }
            for (let j = first_number; j <= second_number; j++) {
              numbers.push(j);
            }
          } else {
            let number = parseInt(split_part);
            if (isNaN(number)) {
              return false;
            }

            numbers.push(number);
          }
        }

        if (type != MULTI_DESCRIPTION_TYPE.BY_ROUND) {
          for (let i = 0; i < numbers.length; i++) {
            if (numbers[i] > max_reps) {
              return false;
            }
          }
        }

        return true;
      }

      function containsOnlyAcceptableChars(str) {
        return /^[0-9,-]+$/.test(str);
      }

      function assignLanesClicked() {
        const assign_lanes_popup =
          document.getElementById("assign_lanes_popup");
        const pick_set_display = document.getElementById("pick_set_display");
        const sendoff_lists = assign_lanes_popup.sendoff_lists;

        const assign_lanes_inner = assign_lanes_popup.children[0];

        for (let i = 0; i < assign_lanes_inner.children.length - 1; i++) {
          const wrapper = assign_lanes_inner.children[i];
          const lane = parseInt(
            wrapper.children[0].innerText
              .substring("Lane ".length)
              .replace(":", "")
              .trim()
          );
          const letter = wrapper.children[1].selectedOptions[0].innerText;
          const swimmer_count = parseInt(
            wrapper.children[3].selectedOptions[0].innerText
          );
          const seconds_apart = parseInt(
            wrapper.children[5].selectedOptions[0].innerText
          );

          LANES[lane].sendoff_list = sendoff_lists[letter];
          LANES[lane].letter = letter;
          LANES[lane].swimmer_count = swimmer_count;
          LANES[lane].seconds_apart = seconds_apart;
        }

        cleanSendoffLists();
        sendSendoffLists(sendoff_lists);
        assignSendoffLists();

        assign_lanes_popup.remove();
        pick_set_display.remove();
      }

      function sendSendoffLists(sendoff_lists) {
        fillOutSendoffLists();
        let lanes = Object.keys(LANES);
        let data = {
          action: "sendSendoffLists",
          roomKey: roomKey,
          lists: {},
        };

        for (let i = 0; i < lanes.length; i++) {
          data.lists[lanes[i]] = LANES[lanes[i]].sendoff_list;
        }

        socket.send(JSON.stringify(data));
      }

      function fillOutSendoffLists() {
        let lanes = Object.keys(LANES);
        for (let i = 0; i < lanes.length; i++) {
          let lane = lanes[i];
          LANES[lane].sendoffs_filled_out = true;
          let sendoff_list = LANES[lane].sendoff_list.list;
          let swimmer_count = LANES[lane].swimmer_count;
          let seconds_apart = LANES[lane].seconds_apart;

          let new_list = [];
          for (let j = 0; j < sendoff_list.length; j++) {
            let sendoff_adding_to = sendoff_list[j];
            let add_time = seconds_apart;
            sendoff_adding_to.swimmer_number = 1;
            new_list.push(sendoff_adding_to);
            for (let k = 1; k < swimmer_count; k++) {
              let new_object = {
                time: sendoff_adding_to.time + add_time,
                rep_time: sendoff_adding_to.rep_time,
                distance: sendoff_adding_to.distance,
                description: sendoff_adding_to.description,
                rep_number: sendoff_adding_to.rep_number,
                swimmer_number: k + 1,
              };
              new_list.push(new_object);
              add_time = add_time + seconds_apart;
            }
          }
          LANES[lane].sendoff_list.list = new_list;
        }
      }

      function assignSendoffLists() {
        let lanes = Object.keys(LANES);
        for (let i = 0; i < lanes.length; i++) {
          let lane = LANES[lanes[i]];
          let lane_panel = lane.lane_panel;

          const sendoff_table = document.createElement("table");
          sendoff_table.id = "lane" + lane[i] + "sendofftable";
          lane_panel.appendChild(sendoff_table);

          let sendoff_list = lane.sendoff_list.list;

          for (let j = 0; j < sendoff_list.length; j++) {
            let sendoff = sendoff_list[j];
            const row = document.createElement("tr");
            sendoff_table.appendChild(row);

            const swimmer_number = document.createElement("td");
            swimmer_number.innerText = "S# " + sendoff.swimmer_number;
            row.appendChild(swimmer_number);

            const rep_number = document.createElement("td");
            rep_number.innerText = "R# " + sendoff.rep_number;
            row.appendChild(rep_number);

            const sendoff_time = document.createElement("td");
            sendoff_time.innerText = valueToClockDisplay(sendoff.time);
            row.appendChild(sendoff_time);

            const distance = document.createElement("td");
            distance.innerText = sendoff.distance;
            row.appendChild(distance);

            const description = document.createElement("td");
            description.innerText = sendoff.description;
            row.appendChild(description);

            row.sendoff = sendoff;
          }
        }

        lanes.forEach((lane) => assignDisplayFromNextInTable(lane));
      }

      function valueToClockDisplay(value) {
        let min = Math.floor(value / 60);
        let sec = value % 60;

        min < 10 ? (min = "0" + min) : (min = min.toString());
        sec < 10 ? (sec = "0" + sec) : (sec = sec.toString());

        return min + ":" + sec;
      }

      function cleanSendoffLists() {
        let lanes = Object.keys(LANES);
        for (let i = 0; i < lanes.length; i++) {
          let lane = LANES[lanes[i]];
          let lane_panel = lane.lane_panel;

          let sendoff_list = lane.sendoff_list.list;

          for (let j = 0; j < sendoff_list.length; j++) {
            let sendoff = sendoff_list[j];
            let description = sendoff.description;
            let split_description = description.split("\n");
            if (split_description.count > 1)
              sendoff.description = split_description[0];
          }
        }
      }

      function assignDisplayFromNextInTable(lane) {
        try {
          const lane_panel = LANES[lane].lane_panel;
          const next_up_display = lane_panel.children[8];
          const next_up_table = lane_panel.children[9];
          if (next_up_table.children.length > 1) {
            const sendoff = next_up_table.children[0].sendoff;

            while (next_up_display.children.length > 0) {
              next_up_display.children[0].remove();
            }

            const swimmer_number = document.createElement("div");
            swimmer_number.innerText = "Swimmer #" + sendoff.swimmer_number;
            next_up_display.appendChild(swimmer_number);

            const swimmer_time = document.createElement("div");
            swimmer_time.innerText =
              valueToClockDisplay(sendoff.time) +
              " - " +
              sendoff.distance +
              " " +
              sendoff.description;
            next_up_display.appendChild(swimmer_time);
            displayChange(next_up_display);
          }
        } catch {}
      }

      function processTimeForLane(lane, time_display) {
        const lane_panel = LANES[lane].lane_panel;
        const next_up_display = lane_panel.children[8];
        const next_up_table = lane_panel.children[9];
        const next_up_time =
          next_up_display.children[1].innerText.split(" - ")[0];

        if (next_up_time == time_display) {
          if (next_up_table.children.length > 1) {
            next_up_table.children[0].remove();
            assignDisplayFromNextInTable(lane);
          } else {
            while (next_up_display.children.length > 0) {
              next_up_display.children[0].remove();
            }
          }
        }
      }

      let ELEMENTS_CHANGING = [];
      function displayChange(element) {
        element.green_amount = 255;
        ELEMENTS_CHANGING.push(element);
      }

      function processGreenChanges() {
        for (let i = 0; i < ELEMENTS_CHANGING.length; i++) {
          const element = ELEMENTS_CHANGING[i];
          element.style.backgroundColor = `rgb(0, ${element.green_amount}, 0)`;
          element.green_amount--;
        }
      }
    </script>
  </body>
</html>
