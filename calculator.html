<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Swimmer Client</title>
    <link
      href="https://fonts.googleapis.com/css?family=Noto Sans Mono"
      rel="stylesheet"
    />
    <style>
      #Main_Clock {
        color: greenyellow;
        font-size: 25.5vw;
        font-weight: 600;
        font-family: "Noto Sans Mono", "Courier New", Courier, monospace;
      }

      #container {
        width: 100vw;
        height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .black_background {
        background-color: black;
      }

      #connection_status {
        position: fixed;
        bottom: 3px;
        right: 3px;
        color: white;
        font-weight: bolder;
      }
    </style>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.2.0/dist/peerjs.min.js"></script>
  </head>
  <body onunload="disconnect()">
    <div class="container" id="container">
      <button type="button" onclick="startApp(0)" id="fullscreenbutton">
        Cick Me To Just Start Clock
      </button>
      <button type="button" onclick="startApp(1)" id="withconnectionbutton">
        Click Me To Start With Connection
      </button>
    </div>

    <script>
      const SKIP_FULLSCREEN = 1;
      const BASE_URL = "http://localhost:3000/";
      const PEER_BASE = "3SLDFGPSOGHAA";
      const PEER_TYPE = "LANE";
      const COACH_ID = PEER_BASE + "-" + "COACH";
      let ID = PEER_BASE + "-" + PEER_TYPE;
      let CONNECTED_TO_COACH = false;

      var clock;
      var time_delta;

      async function getTimeDelta() {
        const start_millis = Date.now();
        const response = await axios.get(
          `https://worldtimeapi.org/api/timezone/America/Detroit`
        );
        const end_millis = Date.now();
        const data = response.data;

        const trip_time = end_millis - start_millis;
        const server_millis = parseInt(
          data["unixtime"] +
            data["utc_datetime"].split(".")[1].split("+")[0].substring(0, 3)
        );

        time_delta = server_millis - start_millis - Math.floor(trip_time / 2);
      }

      function SetClock() {
        var start = Date.now() + time_delta;
        const date = new Date(start);
        var minutes = date.getMinutes();
        var seconds = date.getSeconds();
        const checkTime = (i) => {
          if (i < 10) return `0${i}`;
          return i + "";
        };
        const minute = checkTime(minutes);
        const second = checkTime(seconds);
        clock.innerText = `${minute}:${second}`;
      }

      function requestFullScreen(div_to_fullscreen) {
        //request Full Screen
        if (typeof SKIP_FULLSCREEN === "undefined") return;
        if (SKIP_FULLSCREEN == 1) return;

        if (div_to_fullscreen.requestFullscreen) {
          div_to_fullscreen.requestFullscreen();
        } else if (div_to_fullscreen.webkitRequestFullscreen) {
          /* Safari */
          div_to_fullscreen.webkitRequestFullscreen();
        } else if (div_to_fullscreen.msRequestFullscreen) {
          /* IE11 */
          div_to_fullscreen.msRequestFullscreen();
        }
      }

      async function startApp(button_clicked) {
        if (button_clicked === 0) {
          setupClock();
        } else {
          removeInitialButtons();

          let lane_selector = document.createElement("input");
          lane_selector.type = "number";
          lane_selector.id = "lane_selector";
          lane_selector.min = 1;
          lane_selector.max = 10;
          lane_selector.value = 1;

          let lane_label = document.createElement("label");
          lane_label.htmlFor = "lane_selector";
          lane_label.innerText = "Select your lane: ";
          lane_label.id = "lane_label";

          let connect_button = document.createElement("button");
          connect_button.id = "connect_button";
          connect_button.type = "button";
          connect_button.innerText = "Connect";
          connect_button.addEventListener("click", ConnectToCoach);

          let container = document.getElementById("container");

          container.appendChild(lane_label);
          container.appendChild(lane_selector);
          container.appendChild(connect_button);
        }
      }

      async function setupClock() {
        var main_screen = document.getElementById("container");
        requestFullScreen(main_screen);

        //Update the display to the clock - will need to refactor later
        removeInitialButtons();

        clock = document.createElement("p");
        clock.id = "Main_Clock";
        clock.className = "Main_Clock";
        clock.innerText = "00:00";
        main_screen.classList.add("black_background");
        main_screen.appendChild(clock);

        //start the clock
        await getTimeDelta();
        StartClock();
      }

      function removeInitialButtons() {
        const container = document.getElementById("container");
        while (container.firstChild) {
          container.removeChild(container.firstChild);
        }
      }

      function ResetClock() {
        SetClock();
      }

      function SetClockToTickEverySecond() {
        SetClock();
        setInterval(ResetClock, 1000);
      }

      async function StartClock() {
        SetClock();
        var start = Date.now() + time_delta;
        const date = new Date(start);
        var delay = 1000 - date.getMilliseconds();
        setTimeout(SetClockToTickEverySecond, delay);
      }

      function ConnectToCoach() {
        ID += "-" + document.getElementById("lane_selector").value;

        //if (typeof peer !== "undefined") {
        //  if (peer) {
        //    peer.destroy();
        //  }
        //}

        peer = new Peer([ID], {});

        //connection to SERVER has been established
        peer.on("open", function (id) {
          _connect();
        });

        //conection object created, now register what to do with it
        //peer.on("connection", function (c) {});

        //connection failed. Likely because someone else is already connected
        //with that lane
        peer.on("error", (err) => {
          _errorConnecting(err);
        });
      }

      function _connect() {
        conn = peer.connect(COACH_ID, { serialization: "json" });

        conn.on("open", function () {
          //connection with coach opened

          conn.on("data", function (data) {
            if ("error" in data) {
              _errorConnecting({ message: "That lane is taken" });
              conn.close();
            }

            if ("connection_sucess" in data) {
              setupClock();

              let connection_status_div = document.createElement("div");
              connection_status_div.id = "connection_status";
              connection_status_div.innerText = "Connected to Coach";
              let temp = document.getElementById("container");
              temp.appendChild(connection_status_div);
            }
          });
        });
      }

      function _errorConnecting(err) {
        let p = document.createElement("p");
        if (err.message == "Lost connection to server.") {
          p.innerText = "Error. ";
          console.log("Retry");
        } else if (err.message.includes("is taken")) {
          console.log("Lane taken");
          p.innerText = "That lane is taken";
        }

        p.id = "connection_error";
        let temp = document.getElementById("container");
        temp.appendChild(p);
      }

      function disconnect() {
        peer.destroy();
      }
    </script>
  </body>
</html>
