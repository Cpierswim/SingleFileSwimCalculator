<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TimeTester</title>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  </head>
  <body>
    <p id="clock"></p>
    <p>
      <button id="set_to_zero" onclick="return setToZero()">Set to 0</button>
    </p>
    <p id="messages"></p>

    <script>
      let messages = document.getElementById("messages");
      let clock = document.getElementById("clock");

      let time_delta;
      let original_time_delta;

      async function getTimeDelta() {
        const start_millis = Date.now();
        const response = await axios.get(
          `https://worldtimeapi.org/api/timezone/America/Detroit`
        );
        const end_millis = Date.now();
        const data = response.data;

        const trip_time = end_millis - start_millis;
        const server_millis = parseInt(
          data["unixtime"] +
            data["utc_datetime"].split(".")[1].split("+")[0].substring(0, 3)
        );

        time_delta = server_millis - start_millis - Math.floor(trip_time / 2);
        original_time_delta = time_delta;

        messages.innerHTML = "Time Delta: " + time_delta;
      }

      function startTimer() {
        setInterval(setClock, 10);
      }

      function setClock() {
        let now_time_stap = Date.now();
        let now = new Date(now_time_stap);
        clock.innerHTML = "My clock: " + now.toString();
        let addLeadingZeroes = (i) => {
          if (i < 10) return `0${i}`;
          return i.toString();
        };

        let mills = now.getMilliseconds().toString();
        if (mills.length > 2) mills = mills.toString().substring(0, 2);
        let milisctring =
          "<br />" +
          addLeadingZeroes(now.getMinutes()) +
          ":" +
          addLeadingZeroes(now.getSeconds()) +
          "." +
          mills;
        clock.innerHTML += milisctring;

        let accurate_now = new Date(now_time_stap + time_delta);
        clock.innerHTML += "<br />Adjusted: " + accurate_now.toString();

        let adjusted_mills = accurate_now.getMilliseconds().toString();
        if (adjusted_mills > 2)
          adjusted_mills = adjusted_mills.toString().substring(0, 2);
        let secondmilistring =
          "<br />" +
          addLeadingZeroes(accurate_now.getMinutes()) +
          ":" +
          addLeadingZeroes(accurate_now.getSeconds()) +
          "." +
          adjusted_mills;
        clock.innerHTML += secondmilistring;
      }

      async function StartEverything() {
        await getTimeDelta();
        startTimer();
      }

      function setToZero() {
        let now = Date.now();
        let adjusted_time = new Date(now);

        adjusted_time.setSeconds(0);
        adjusted_time.setMilliseconds(0);
        let adjusted_time_stamp = adjusted_time.getTime();

        let additional_delta = now - adjusted_time_stamp;

        time_delta = 0 - additional_delta;

        messages.innerHTML += "<br />Time Delta now: " + time_delta;
      }

      StartEverything();
    </script>
  </body>
</html>
