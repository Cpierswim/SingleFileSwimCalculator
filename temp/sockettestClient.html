<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Socket Test Lane</title>
  </head>
  <body onbeforeunload="return closeWebSocket()">
    <input type="text" id="Room_Key" />
    <br />
    <button id="sendMessageButton" onclick="sendMessage()">Send Message</button>
    <br />
    <p id="Message">Connecting to AWS...</p>
    <script>
      let my_lane;
      const example_socket = new WebSocket(
        "wss://mjim68pp6h.execute-api.us-east-2.amazonaws.com/production/"
      );

      example_socket.onopen = (event) => {
        debugger;
        let p = document.getElementById("Message");
        p.innerHTML = p.innerHTML + "<br />Connected to AWS";
        let set_connection_type_data = {
          action: "setConnectionType",
          type: "swimmer",
        };
        example_socket.send(JSON.stringify(set_connection_type_data));
        setInterval(() => example_socket.send({ action: "keepAlive" }), 120000);
      };

      example_socket.onerror = (event) => {
        debugger;
        let p = document.getElementById("Message");
        p.innerHTML = p.innerHTML + "<br />There was an error";
        p.innerHTML = p.innerHTML + "<br />Error: " + event.toString();
      };

      example_socket.onmessage = (event) => {
        debugger;
        let p = document.getElementById("Message");
        p.innerHTML = p.innerHTML + "<br />Message revieved";
        let data = JSON.parse(event.data);
        if (data?.message == "Internal server error")
          p.innerHTML = p.innerHTML += "<br />" + data.message;
        if (data?.type == "LaneConnect") {
          processLaneConnect(data.laneNumber);
        } else if (data?.type == "error") {
          p.innerHTML += "<br />" + data.message;
        }
      };

      example_socket.onclose = (event) => {
        debugger;
        let p = document.getElementById("Message");
        p.innerHTML = p.innerHTML + "<br />Connection closed";
      };

      function sendMessage() {
        debugger;
        let p = document.getElementById("Message");

        let roomKey = document.getElementById("Room_Key").value;
        p.innerHTML =
          p.innerHTML + "<br />Attempting to connect to room:" + roomKey;
        let data = {
          action: "laneConnect",
          LaneNumber: "1",
          roomKey: roomKey,
        };
        example_socket.send(JSON.stringify(data));
      }

      function processLaneConnect(lane) {
        debugger;
        let p = document.getElementById("Message");
        p.innerHTML = p.innerHTML + "<br />Connected to Lane " + lane;
      }

      function closeWebSocket() {
        debugger;
        example_socket.close();
      }
    </script>
  </body>
</html>
